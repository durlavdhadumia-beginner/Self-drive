{% extends "base.html" %}
{% block title %}Admin | Live Map{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
    <style>
        #admin-map {
            height: 480px;
            min-height: 480px;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(15, 118, 110, 0.1);
        }
        @media (max-width: 576px) {
            #admin-map {
                height: 360px;
                min-height: 360px;
            }
        }
        .leaflet-marker-icon.marker-active {
            filter: hue-rotate(-120deg) saturate(1.6);
        }
        .admin-map-pin {
            display: block;
            width: 20px;
            height: 20px;
            background: #2563eb;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
            position: relative;
        }
        .admin-map-pin::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #2563eb;
        }
        .admin-map-pin-active {
            background: #16a34a;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.45);
        }
        .admin-map-pin-active::after {
            border-top-color: #16a34a;
        }
    </style>
{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h4 fw-bold mb-1">Live vehicle map</h1>
                <p class="text-muted mb-0">View all listed vehicles and highlight those currently on trips.</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">Back to dashboard</a>
        </div>
        <div id="admin-map"></div>
    </div>
</section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
    <script>
        let adminMapInstance = null;
        document.addEventListener('DOMContentLoaded', () => {
            const mapElement = document.getElementById('admin-map');
            if (!mapElement) {
                return;
            }
            adminMapInstance = L.map(mapElement).setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors'
            }).addTo(adminMapInstance);

            const listings = {{ vehicles|tojson|safe }};
            const activeIds = new Set({{ active_vehicle_ids|tojson|safe }});
            const buildIcon = (isActive) => L.divIcon({
                className: isActive ? 'admin-map-pin admin-map-pin-active' : 'admin-map-pin',
                iconSize: [20, 28],
                iconAnchor: [10, 24],
                popupAnchor: [0, -20]
            });
            if (Array.isArray(listings) && listings.length) {
                const bounds = L.latLngBounds();
                listings.forEach((vehicle) => {
                    const lat = Number(vehicle.latitude);
                    const lng = Number(vehicle.longitude);
                    if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                        return;
                    }
                    const marker = L.marker([lat, lng], {
                        icon: buildIcon(activeIds.has(vehicle.id))
                    });
                    const popup = `<strong>${vehicle.name || 'Vehicle'}</strong><br>${vehicle.vehicle_type || 'Vehicle'} &middot; ${vehicle.city || 'City not set'}<br>Hosted by ${vehicle.owner_username || 'Host'}`;
                    marker.bindPopup(popup);
                    marker.addTo(adminMapInstance);
                    bounds.extend([lat, lng]);
                });
                if (bounds.isValid()) {
                    adminMapInstance.fitBounds(bounds.pad(0.2));
                }
            }

            const invalidate = () => adminMapInstance && adminMapInstance.invalidateSize();
            requestAnimationFrame(invalidate);
            setTimeout(invalidate, 250);
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(invalidate, 150);
            });
        });

        window.addEventListener('load', () => {
            if (adminMapInstance) {
                setTimeout(() => adminMapInstance.invalidateSize(), 200);
            }
        });
    </script>
{% endblock %}
