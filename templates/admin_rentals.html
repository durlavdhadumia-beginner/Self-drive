{% extends "base.html" %}
{% block title %}Admin | Trips{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h4 fw-bold mb-1">Trip overview</h1>
                <p class="text-muted mb-0">Monitor upcoming, live, and completed rentals. Adjust payment status if required.</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">Back to dashboard</a>
        </div>
        <div class="card card-zoom">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Vehicle</th>
                                <th>Renter</th>
                                <th>Owner</th>
                                <th>Schedule</th>
                                <th>Status</th>
                                <th>Payment by renter</th>
                                <th>Payout to host</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rental in rentals %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ rental['booking_identifier'] }}</div>
                                        <div class="text-muted small">#{{ rental['id'] }}</div>
                                    </td>
                                    <td>{{ rental['car_name'] }}<br><span class="text-muted small">{{ rental['brand'] }} {{ rental['model'] }}</span>
                                        {% if rental['images'] %}
                                            <div class="d-flex flex-wrap gap-1 mt-2">
                                                {% for image in rental['images'][:4] %}
                                                    <a href="{{ url_for('serve_upload', filename=image) }}" target="_blank" rel="noopener">
                                                        <img src="{{ url_for('serve_upload', filename=image) }}" alt="{{ rental['car_name'] }}" class="rounded" style="width:64px;height:42px;object-fit:cover;">
                                                    </a>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ rental['renter_display_name'] }}<br>
                                        <span class="text-muted small">{{ rental['renter_username'] }}</span>
                                    </td>
                                    <td>
                                        {{ rental['owner_display_name'] }}<br>
                                        <span class="text-muted small">{{ rental['owner_username'] }}</span>
                                    </td>
                                    <td class="text-muted small">
                                        <div><strong>Start:</strong> {{ rental['start_time']|trip_datetime if rental['start_time'] else 'TBD' }}</div>
                                        <div><strong>End:</strong> {{ rental['end_time']|trip_datetime if rental['end_time'] else 'TBD' }}</div>
                                    </td>
                                    <td>{{ rental['status']|capitalize }}</td>
                                    <td>{{ rental['payment_status']|replace('_', ' ')|capitalize }}<br><span class="text-muted small">Due: {{ rental['payment_due_at'] or '-' }}</span><br><span class="text-muted small">Total: Rs {{ rental['total_amount']|round|int }}</span></td>
                                    <td>
                                        <div class="fw-semibold">Owner share (Net take-home): Rs {{ rental['owner_share_amount']|round(2) }}</div>
                                        <div class="text-muted small">Advance amount paid (10%): Rs {{ rental['owner_advance_amount']|round(2) }}</div>
                                        <div class="text-muted small">Balance pending: Rs {{ rental['owner_balance_amount']|round(2) }}</div>
                                        <div class="text-muted small">Status: {{ rental['owner_payout_status']|capitalize }}</div>
                                        {% if rental['owner_payout_released_at'] %}
                                            <div class="text-muted small">Released: {{ rental['owner_payout_released_at'] }}</div>
                                        {% endif %}
                                        {% if rental['owner_payout_status'] != 'paid' and rental['payment_status'] == 'paid' %}
                                            <form method="post" action="{{ url_for('admin_release_owner_payout', rental_id=rental['id']) }}" class="mt-2">
                                                <button type="submit" class="btn btn-sm btn-outline-success">Mark released</button>
                                            </form>
                                        {% endif %}
                                        <details class="mt-3">
                                            <summary class="text-muted small">Activity log</summary>
                                            {% if rental['activity_logs'] %}
                                                <ul class="list-unstyled small mb-0 pt-2">
                                                    {% for log in rental['activity_logs'] %}
                                                        <li class="mb-1">
                                                            <span class="text-muted">{{ log['created_at']|trip_datetime }}</span>
                                                            <span class="text-muted">&mdash;</span>
                                                            <span class="fw-semibold">{{ log['actor_name'] or log['actor_role']|capitalize }}</span>
                                                            {{ log['message'] or log['action']|replace('_', ' ')|title }}
                                                            {% if log['metadata_display'] %}
                                                                <span class="text-muted">({{ log['metadata_display'] }})</span>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div class="text-muted small pt-2">No activity recorded.</div>
                                            {% endif %}
                                        </details>
                                    </td>
                                    <td class="text-end">
                                        <form method="post" action="{{ url_for('admin_update_payment', rental_id=rental['id']) }}" class="d-inline-flex gap-2 align-items-center">
                                            <select class="form-select form-select-sm" name="payment_status">
                                                <option value="awaiting_payment" {% if rental['payment_status'] == 'awaiting_payment' %}selected{% endif %}>Awaiting</option>
                                                <option value="paid" {% if rental['payment_status'] == 'paid' %}selected{% endif %}>Paid</option>
                                                <option value="pending" {% if rental['payment_status'] == 'pending' %}selected{% endif %}>Pending</option>
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-outline-success">Update</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
