{% extends "base.html" %}
{% block title %}Admin | {{ user['display_name'] }} profile{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
    <style>
        .admin-user-detail-page {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        .admin-user-detail-page .page-content {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            padding-bottom: 4rem;
        }
        .admin-user-detail-page .page-content .row.g-4 {
            flex: 1 0 auto;
        }
        .admin-vehicle-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }
        .admin-vehicle-list-card {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        .admin-vehicle-list-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }
        .admin-vehicle-list {
            flex: 1 1 auto;
            overflow-y: auto;
        }
        .admin-gallery-thumb {
            width: 96px;
            height: 64px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .admin-detail-map,
        .admin-edit-location-map {
            height: 240px;
            min-height: 240px;
        }
        .map-pin {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #fff;
            font-weight: 600;
            color: #fff;
            box-shadow: 0 6px 12px rgba(15, 118, 110, 0.25);
            position: relative;
            background: #2563eb;
        }
        .map-pin::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            margin-left: -6px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-top-color: currentColor;
        }
        .map-pin-labeled {
            font-size: 0.75rem;
        }
        .map-pin-car {
            background: #2563eb;
        }
        .map-pin-delivery {
            background: #0d9488;
        }
        .admin-edit-modal-body {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .admin-photo-input-row {
            display: flex;
            gap: 0.5rem;
        }
    </style>
{% endblock %}
{% block content %}
<section class="admin-user-detail-page py-5">
    <div class="container page-content">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3 align-items-md-center mb-4">
            <div>
                <h1 class="h4 fw-bold mb-1">User profile overview</h1>
                <p class="text-muted mb-0">Review identity details, uploaded compliance documents, and payout preferences.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">Back to users</a>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-success">Admin dashboard</a>
            </div>
        </div>
        <div class="row g-4 flex-grow-1">
            <div class="col-lg-7">
                <div class="admin-vehicle-column">
                    <div class="card card-zoom">
                        <div class="card-body">
                            <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
                                <div>
                                    <h2 class="h5 fw-bold mb-1">{{ user['display_name'] }}</h2>
                                    <div class="text-muted small">Login ID: {{ user['username'] }}</div>
                                    <p class="text-muted small mb-0">Account ID #{{ user['id'] }}</p>
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-success-subtle text-success text-uppercase">{{ user['role']|replace('_', ' ') }}</span>
                                    {% if user['is_admin'] %}
                                        <span class="badge bg-dark-subtle text-dark">Admin</span>
                                    {% endif %}
                                    {% if profile.get('profile_completed') %}
                                        <span class="badge bg-success-subtle text-success">Profile complete</span>
                                    {% else %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis">Profile incomplete</span>
                                    {% endif %}
                                    {% if profile.get('profile_verified_at') %}
                                        <span class="badge bg-primary-subtle text-primary">Verified {{ profile['profile_verified_at'] }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary">Not verified</span>
                                    {% endif %}
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Full name</span>
                                    <div class="fw-semibold">{{ profile['full_name'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Date of birth</span>
                                    <div class="fw-semibold">{{ profile['date_of_birth'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Mobile</span>
                                    <div class="fw-semibold">{{ profile['phone'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Email</span>
                                    <div class="fw-semibold">{{ profile['email_contact'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Address</span>
                                    <div class="fw-semibold">{{ profile['address'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Vehicle registration</span>
                                    <div class="fw-semibold">{{ profile['vehicle_registration'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">GPS tracking consent</span>
                                    <div class="fw-semibold">{{ 'Enabled' if profile.get('gps_tracking') else 'Disabled' }}</div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 rounded bg-light d-flex flex-wrap gap-4">
                                <div>
                                    <div class="text-muted text-uppercase small">Vehicles hosted</div>
                                    <div class="fs-5 fw-bold">{{ stats['vehicle_count'] }}</div>
                                </div>
                                <div>
                                    <div class="text-muted text-uppercase small">Trips booked</div>
                                    <div class="fs-5 fw-bold">{{ stats['trip_count'] }}</div>
                                </div>
                                <div>
                                    <div class="text-muted text-uppercase small">Documents</div>
                                    <div class="fs-5 fw-bold">{{ documents|length }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card card-zoom mt-4">
                        <div class="card-body">
                            <h2 class="h5 fw-bold mb-3">Payout preferences</h2>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Account holder</span>
                                    <div class="fw-semibold">{{ payout.get('account_holder') or profile['full_name'] or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">Account number</span>
                                    <div class="fw-semibold">{{ payout.get('account_number') or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">IFSC code</span>
                                    <div class="fw-semibold">{{ payout.get('ifsc_code') or 'Not provided' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <span class="text-muted text-uppercase small fw-semibold">UPI ID</span>
                                    <div class="fw-semibold">{{ payout.get('upi_id') or 'Not provided' }}</div>
                                </div>
                            </div>
                            {% if payout.get('updated_at') %}
                                <p class="text-muted small mb-0 mt-3">Last updated {{ payout['updated_at'] }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card card-zoom admin-vehicle-list-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 fw-bold mb-0">Vehicles listed ({{ cars|length }})</h2>
                                {% if cars %}
                                    <span class="badge bg-success-subtle text-success text-uppercase">Active fleet</span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary text-uppercase">No vehicles</span>
                                {% endif %}
                            </div>
                            {% if cars %}
                                <div class="list-group list-group-flush admin-vehicle-list">
                                    {% for car in cars %}
                                        <div class="list-group-item px-0 py-3" data-admin-car-card="{{ car['id'] }}" data-admin-detail-url="{{ url_for('owner_get_car_data', car_id=car['id']) }}" data-admin-update-url="{{ url_for('owner_update_car', car_id=car['id']) }}">
                                            <div class="d-flex justify-content-between align-items-start mb-3 gap-3">
                                                <div>
                                                    <h3 class="h6 fw-semibold mb-1" data-admin-role="name">{{ car['name'] or car['brand'] ~ ' ' ~ car['model'] }}</h3>
                                                    <p class="text-muted small mb-0" data-admin-role="subtitle">
                                                        {{ car['brand'] or 'Unknown' }} {{ car['model'] or '' }}{% if car['city'] %} &bull; {{ car['city'] }}{% else %} &bull; City not set{% endif %}
                                                    </p>
                                                </div>
                                                <span class="badge {{ 'bg-success' if car['is_available'] else 'bg-secondary' }} text-white" data-admin-role="availability">
                                                    {{ 'Available' if car['is_available'] else 'Unavailable' }}
                                                </span>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2 mb-3" data-admin-role="gallery">
                                                {% if car['images'] %}
                                                    {% for image in car['images'] %}
                                                        <button type="button" class="btn btn-link p-0" data-admin-view="{{ car['id'] }}" aria-label="Preview {{ car['name'] or car['brand'] ~ ' ' ~ car['model'] }}">
                                                            <img src="{{ url_for('serve_upload', filename=image) }}" alt="{{ car['name'] }}" class="admin-gallery-thumb">
                                                        </button>
                                                    {% endfor %}
                                                {% else %}
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-admin-edit="{{ car['id'] }}">
                                                        <i class="bi bi-plus-circle me-1"></i>Add photos
                                                    </button>
                                                {% endif %}
                                            </div>
                                            <div class="row g-2 text-muted small mb-3">
                                                <div class="col-sm-6" data-admin-role="licence">Licence: {{ car['licence_plate'] or 'Pending' }}</div>
                                                <div class="col-sm-6" data-admin-role="seats">Seats: {{ car['seats'] or 'N/A' }}</div>
                                                <div class="col-sm-6" data-admin-role="rate-hour">Hourly rate: &#8377;{{ '%.0f'|format(car['rate_per_hour'] or 0) }}</div>
                                                <div class="col-sm-6" data-admin-role="rate-day">Daily rate: &#8377;{{ '%.0f'|format(car['daily_rate'] or 0) }}</div>
                                                <div class="col-sm-6" data-admin-role="fuel">Fuel: {{ car['fuel_type'] or 'N/A' }}</div>
                                                <div class="col-sm-6" data-admin-role="transmission">Transmission: {{ car['transmission'] or 'N/A' }}</div>
                                                <div class="col-12" data-admin-role="location-label">
                                                    Location: {% if car['city'] %}{{ car['city'] }}{% else %}Not set{% endif %}
                                                </div>
                                                {% set delivery_map = car['delivery_options'] or {} %}
                                                <div class="col-12" data-admin-role="delivery-summary">
                                                    {% if delivery_map %}
                                                        Delivery: {% for distance, price in delivery_map|dictsort %}
                                                            Up to {{ distance }} km (&#8377;{{ price|round|int }}){% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Delivery: Not offered
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2">
                                                <button type="button" class="btn btn-outline-success btn-sm" data-admin-view="{{ car['id'] }}">View details</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-admin-edit="{{ car['id'] }}">Manage listing</button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted mb-0">This user has not listed any vehicles yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h2 class="h5 fw-bold mb-3">Documents</h2>
                        {% if documents %}
                            <ul class="list-group list-group-flush">
                                {% for doc in documents %}
                                    <li class="list-group-item px-0 py-3 d-flex flex-column gap-2">
                                        <div class="d-flex justify-content-between align-items-center gap-3">
                                            <div>
                                                <div class="fw-semibold">{{ doc['doc_type'] or 'Supporting document' }}</div>
                                                <div class="text-muted small">{{ doc['created_at'] }}</div>
                                            </div>
                                            <div class="btn-group">
                                                <a href="{{ url_for('admin_download_user_document', user_id=user['id'], doc_id=doc['id']) }}" class="btn btn-outline-primary btn-sm">Download</a>
                                                <a href="{{ url_for('static', filename='uploads/' ~ doc['filename']) }}" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm">Preview</a>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="text-muted small">No documents uploaded yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="adminCarModal" tabindex="-1" aria-labelledby="adminCarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminCarModalLabel">Vehicle overview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="fw-semibold fs-5" data-admin-detail="name"></div>
                    <div class="text-muted small" data-admin-detail="subtitle"></div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="text-muted text-uppercase small fw-semibold">Location</div>
                        <div data-admin-detail="city">-</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted text-uppercase small fw-semibold">Rates</div>
                        <div data-admin-detail="rates">-</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted text-uppercase small fw-semibold">Vehicle type</div>
                        <div data-admin-detail="vehicle">-</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted text-uppercase small fw-semibold">Fuel &amp; transmission</div>
                        <div data-admin-detail="fuel">-</div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="text-muted text-uppercase small fw-semibold mb-2">Location map</div>
                    <div class="rounded-4 border overflow-hidden admin-detail-map" id="admin-detail-map"></div>
                    <div class="text-muted small mt-2" data-admin-detail="location-summary">Location not set.</div>
                </div>
                <div class="mb-3">
                    <div class="text-muted text-uppercase small fw-semibold mb-2">Delivery options</div>
                    <ul class="list-group" data-admin-detail="delivery">
                        <li class="list-group-item text-muted small">No delivery charges configured.</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <div class="text-muted text-uppercase small fw-semibold mb-2">Highlights</div>
                    <p class="text-muted small mb-0" data-admin-detail="description">No description provided.</p>
                </div>
                <div>
                    <div class="text-muted text-uppercase small fw-semibold mb-2">Gallery</div>
                    <div class="d-flex flex-wrap gap-2" data-admin-detail="gallery"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" data-admin-detail="open-edit">Edit listing</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="adminEditCarModal" tabindex="-1" aria-labelledby="adminEditCarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <form id="admin-edit-car-form" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminEditCarModalLabel">Edit vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body admin-edit-modal-body">
                    <div class="alert alert-success d-none" role="alert" data-admin-edit-feedback></div>
                    <input type="hidden" name="car_id" data-admin-field="id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-name">Display name</label>
                            <input type="text" class="form-control" id="admin-edit-name" name="name" data-admin-field="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-licence">Licence plate</label>
                            <input type="text" class="form-control" id="admin-edit-licence" name="licence_plate" data-admin-field="licence_plate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-brand">Brand</label>
                            <input type="text" class="form-control" id="admin-edit-brand" name="brand" data-admin-field="brand" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-model">Model</label>
                            <input type="text" class="form-control" id="admin-edit-model" name="model" data-admin-field="model" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-rate-hour">Rate per hour (Rs)</label>
                            <input type="number" class="form-control" id="admin-edit-rate-hour" name="rate_per_hour" min="0" step="50" data-admin-field="rate_per_hour">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-rate-day">Daily rate (Rs)</label>
                            <input type="number" class="form-control" id="admin-edit-rate-day" name="daily_rate" min="0" step="50" data-admin-field="daily_rate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-city">City</label>
                            <input type="text" class="form-control" id="admin-edit-city" name="city" list="admin-city-options" data-admin-field="city">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-vehicle-type">Vehicle type</label>
                            <input type="text" class="form-control" id="admin-edit-vehicle-type" name="vehicle_type" data-admin-field="vehicle_type">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-size">Size category</label>
                            <input type="text" class="form-control" id="admin-edit-size" name="size_category" data-admin-field="size_category">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-fuel">Fuel type</label>
                            <input type="text" class="form-control" id="admin-edit-fuel" name="fuel_type" data-admin-field="fuel_type">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-transmission">Transmission</label>
                            <input type="text" class="form-control" id="admin-edit-transmission" name="transmission" data-admin-field="transmission">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small" for="admin-edit-seats">Seats</label>
                            <input type="number" class="form-control" id="admin-edit-seats" name="seats" min="2" max="12" data-admin-field="seats">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small" for="admin-edit-gps">GPS</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="admin-edit-gps" name="has_gps" data-admin-field="has_gps">
                                <label class="form-check-label" for="admin-edit-gps">Vehicle has GPS</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-image-url">Primary image URL</label>
                            <input type="url" class="form-control" id="admin-edit-image-url" name="image_url" data-admin-field="image_url">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-latitude">Latitude</label>
                            <input type="number" class="form-control" id="admin-edit-latitude" name="latitude" step="0.000001" data-admin-field="latitude">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small" for="admin-edit-longitude">Longitude</label>
                            <input type="number" class="form-control" id="admin-edit-longitude" name="longitude" step="0.000001" data-admin-field="longitude">
                        </div>
                        <div class="col-12">
                            <label class="form-label small" for="admin-edit-location-map">Location map</label>
                            <div class="rounded-4 border overflow-hidden admin-edit-location-map" id="admin-edit-location-map"></div>
                            <div class="form-text" data-admin-location-summary>Click the map to update latitude and longitude. We use the city field to suggest a starting position.</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small" for="admin-edit-description">Highlights</label>
                            <textarea class="form-control" id="admin-edit-description" name="description" rows="3" data-admin-field="description"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Current gallery</label>
                            <div class="d-flex flex-wrap gap-3" data-admin-current-images></div>
                            <div class="form-text small">Remove images you no longer want to show. Changes apply after saving.</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small" for="admin-edit-photo-input-list">Add new gallery photos</label>
                            <div id="admin-edit-photo-input-list" class="d-flex flex-column gap-2"></div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="form-text small mb-0" data-admin-photo-helper>Upload additional images (max 8 in total).</div>
                                <button type="button" class="btn btn-outline-success btn-sm" id="admin-add-photo-input">
                                    <i class="bi bi-plus-circle"></i> Add another
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Delivery options</label>
                            <div class="row g-2" id="admin-edit-delivery-options">
                                {% for distance in delivery_choices %}
                                    <div class="col-md-6" data-admin-delivery-row="{{ distance }}">
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" value="{{ distance }}" name="delivery_options" data-admin-delivery-checkbox>
                                                <span class="ms-2 small">Up to {{ distance }} km</span>
                                            </div>
                                            <input type="number" class="form-control" name="delivery_price_{{ distance }}" data-admin-delivery-price placeholder="Charge (Rs)" min="0" step="50" disabled>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Leave unchecked if this distance is not offered for delivery.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" data-admin-edit-submit>Save changes</button>
                </div>
            </form>
        </div>
    </div>
<datalist id="admin-city-options">
    {% for entry in city_entries %}
        {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
        <option value="{{ label }}"></option>
    {% endfor %}
</datalist>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>window.ADMIN_CITY_ENTRIES = {{ city_entries|tojson|safe }};</script>
    <script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
    <script src="{{ url_for('static', filename='js/admin_user_detail.js') }}"></script>
{% endblock %}





