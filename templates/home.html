{% extends "base.html" %}
{% block title %}CarRentalNTravel | Self-Drive & Hosting{% endblock %}
{% set is_owner = g.user and has_role('owner') %}
{% block head %}
    {{ super() }}
    <style>
        .category-img {
            height: 220px;
            object-fit: cover;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.12), rgba(37, 99, 235, 0.12));
        }
    </style>
{% endblock %}
{% block content %}
{% if is_owner %}
<section class="py-5" style="background:linear-gradient(120deg, rgba(13,159,92,0.18), rgba(10,92,54,0.12));">
    <div class="container py-4">
        <div class="row align-items-center g-5">
            <div class="col-lg-6">
                <span class="badge-zoom mb-3 text-uppercase">Grow with CarRentalNTravel</span>
                <h1 class="display-5 fw-bold mb-3">Turn parked cars into a steady, trackable income stream.</h1>
                <p class="fs-5 text-secondary mb-4">
                    Publish your vehicles in minutes, screen every booking with verified renters, and let our payouts team settle every trip directly into your account with clear breakdowns.
                </p>
                <ul class="list-unstyled text-secondary mb-4">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Real-time dashboards for live, upcoming, and completed trips.</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Automated commission deductions with transparent earnings breakdowns.</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Ready-to-use communication templates and instant notifications.</li>
                </ul>
                <div class="d-flex flex-column flex-sm-row gap-3">
                    <a href="{{ url_for('owner_cars') }}" class="btn btn-success btn-lg"><i class="bi bi-speedometer2"></i> Go to host dashboard</a>
                    <a href="{{ url_for('profile') }}" class="btn btn-outline-success btn-lg"><i class="bi bi-person-badge"></i> Complete payout details</a>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h2 class="h4 fw-semibold mb-3">Host performance snapshot</h2>
                        <div class="row g-4 text-muted small">
                            <div class="col-sm-6">
                                <div class="fw-semibold text-success fs-3 mb-1">{{ owner_stats.active_trips if owner_stats else 0 }}</div>
                                <p class="mb-0">Trips currently live</p>
                            </div>
                            <div class="col-sm-6">
                                <div class="fw-semibold text-success fs-3 mb-1">{{ owner_stats.awaiting_payouts if owner_stats else 0 }}</div>
                                <p class="mb-0">Payouts awaiting release</p>
                            </div>
                            <div class="col-sm-6">
                                <div class="fw-semibold text-success fs-3 mb-1">&#8377; {{ owner_stats.take_home_estimate if owner_stats else 0 }}</div>
                                <p class="mb-0">Payouts ready to release</p>
                            </div>
                            <div class="col-sm-6">
                                <div class="fw-semibold text-success fs-3 mb-1">&#8377; {{ owner_stats.take_home_estimate if owner_stats else 0 }}</div>
                                <p class="mb-0">Average host take-home per trip</p>
                            </div>
                        </div>
                        <hr class="my-4">
                        <p class="text-muted mb-2">Need inspiration? Explore our host playbook for pricing ideas, vehicle photography tips, and seasonal demand insights.</p>
                        <a href="{{ url_for('owner_cars') }}#host-tips" class="btn btn-outline-success btn-sm">View hosting playbook</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% if owner_stats and owner_stats.awaiting_payouts %}
<div class="container my-4">
    <div class="alert alert-info d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-0">
        <div>
            <strong>{{ owner_stats.awaiting_payouts }} payout{% if owner_stats.awaiting_payouts != 1 %}s{% endif %} pending.</strong>
            CarRentalNTravel receives each customer payment, retains a {{ commission_rate }}% service fee, and schedules the remaining balance straight to your account.
        </div>
        <div class="text-muted small">
            Amount queued: &#8377; {{ owner_stats.awaiting_total }} Â· Expected take-home: &#8377; {{ owner_stats.take_home_estimate }}
        </div>
    </div>
</div>
{% endif %}

<section class="py-5">
    <div class="container">
        <h2 class="section-title">Why hosts choose CarRentalNTravel</h2>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            <div class="col">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h3 class="h5 fw-semibold">Seamless earnings</h3>
                        <p class="text-muted mb-0">We collect payments, retain the service fee, and schedule the remaining balance straight to your verified bank account or UPI ID.</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h3 class="h5 fw-semibold">Insights that matter</h3>
                        <p class="text-muted mb-0">Live tracking, distance analytics, and payout history help you optimise pricing and availability with confidence.</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h3 class="h5 fw-semibold">Trusted renters</h3>
                        <p class="text-muted mb-0">Every renter completes a secure KYC flow, and you decide who drives your vehicle with instant accept/decline controls.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% else %}
<section class="py-5" style="background:linear-gradient(120deg, rgba(13,159,92,0.12), rgba(10,92,54,0.08));">
    <div class="container py-4">
        <div class="row align-items-center g-5">
            <div class="col-lg-6">
                <span class="badge-zoom mb-3">India's favourite self-drive style experience</span>
                <h1 class="display-5 fw-bold mb-3">Hit the road with premium self-drive vehicles across your city.</h1>
                <p class="fs-5 text-secondary mb-4">
                    Browse SUVs, compact rides, motorcycles, EVs and more. Flexible packages, curated add-ons, and instant confirmation.
                </p>
                <ul class="list-unstyled text-secondary mb-4">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Fuel-efficient & sanitised vehicles</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Zero paperwork at pickup</li>
                </ul>
            </div>
            <div class="col-lg-6">
                <div class="card card-zoom">
                    <div class="card-body">
                        <h2 class="h4 fw-semibold mb-3">Plan your next drive</h2>
                        <form action="{{ url_for('search') }}" method="get" id="hero-search" class="row g-3">
                            <div class="col-12">
                                <label for="city" class="form-label">City</label>
                                <div class="city-autocomplete position-relative">
                                    <input type="text"
                                           class="form-control form-control-lg"
                                           id="city"
                                           name="city"
                                           placeholder="e.g. Bengaluru"
                                           required
                                           autocomplete="off"
                                           role="combobox"
                                           aria-expanded="false"
                                           aria-autocomplete="list"
                                           aria-controls="city-suggestions">
                                    <div class="city-suggestions list-group shadow-sm d-none" id="city-suggestions" role="listbox"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="start_time" class="form-label">Trip start</label>
                                <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                            </div>
                            <div class="col-md-6">
                                <label for="end_time" class="form-label">Trip end</label>
                                <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                            </div>
                            <div class="col-md-6">
                                <label for="radius" class="form-label">Search radius (km)</label>
                                <input type="number" class="form-control" id="radius" name="radius" value="10" min="1" max="200">
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="hero-destination-0">Trip destinations</label>
                                <div class="d-flex flex-column gap-2"
                                     data-destination-container
                                     data-input-name="destinations"
                                     data-add-button="#add-hero-destination"
                                     data-datalist="destination-options"
                                     data-required="true"
                                     data-initial="{{ requested_destinations|tojson|safe }}">
                                    {% for destination in requested_destinations %}
                                        <div class="input-group destination-input-row" data-role="destination-input-row">
                                            <input type="text" class="form-control" name="destinations" value="{{ destination }}" placeholder="Enter destination" autocomplete="off">
                                            <button type="button" class="btn btn-outline-danger" data-role="remove-destination">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text mb-0">Add each planned stop. At least one destination is required.</div>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="add-hero-destination">
                                        <i class="bi bi-plus-circle"></i> Add destination
                                    </button>
                                </div>
                            </div>
                            {% set popular_types = popular_vehicle_types or [] %}
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label" for="vehicle_type">Vehicle type</label>
                                    <select class="form-select" id="vehicle_type" name="vehicle_types">
                                        <option value="">Any vehicle</option>
                                        {% for label in popular_types %}
                                            <option value="{{ label }}">{{ label }}</option>
                                        {% endfor %}
                                        {% for v in vehicle_types %}
                                            {% if v and v not in popular_types %}
                                                <option value="{{ v }}">{{ v }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="fuel_type">Fuel type</label>
                                    <select class="form-select" id="fuel_type" name="fuel_type">
                                        <option value="">Any fuel</option>
                                        {% for fuel in fuel_types %}
                                            <option value="{{ fuel }}">{{ fuel }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label" for="seat_min">Seats (min)</label>
                                    <input type="number" class="form-control" id="seat_min" name="seat_min" min="2" max="12">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="seat_max">Seats (max)</label>
                                    <input type="number" class="form-control" id="seat_max" name="seat_max" min="2" max="12">
                                </div>
                            </div>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label" for="price_unit">Rate type (&#8377;/hr or &#8377;/day)</label>
                                    <select class="form-select" id="price_unit" name="price_unit">
                                        <option value="hour" selected>Per hour</option>
                                        <option value="day">Per day</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-3">
                                        <div class="flex-grow-1">
                                            <label class="form-label" for="price_min">Min rate</label>
                                            <input type="number" class="form-control" id="price_min" name="price_min" min="0" step="50">
                                        </div>
                                        <div class="flex-grow-1">
                                            <label class="form-label" for="price_max">Max rate</label>
                                            <input type="number" class="form-control" id="price_max" name="price_max" min="0" step="50">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="on" id="search-gps" name="require_gps">
                                    <label class="form-check-label" for="search-gps">
                                        Show only vehicles with GPS tracking
                                    </label>
                                </div>
                            </div>
                            <input type="hidden" id="search-lat" name="latitude">
                            <input type="hidden" id="search-lng" name="longitude">
                            <div class="col-12 d-flex flex-column flex-sm-row gap-3">
                                <button type="submit" class="btn btn-success btn-lg flex-grow-1">Search vehicles</button>
                                <button type="button" id="detect-location" class="btn btn-outline-success flex-grow-1"><i class="bi bi-geo-alt"></i> Use my location</button>
                            </div>
                        </form>
                        <datalist id="destination-options">
                            {% for entry in cities %}
                                {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
                                <option value="{{ label }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row g-4 align-items-center">
            <div class="col-lg-5">
                <h2 class="section-title">Own a vehicle? Earn more with your vehicle</h2>
                <p class="text-muted mb-4">List your car or motorcycle in minutes, get instant booking alerts, and track every trip from a single dashboard. Verified IDs, GPS tracking, and admin support keep hosts protected.</p>
                <ul class="list-unstyled text-muted mb-4">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Upload up to eight photos per vehicle and set your own pricing.</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Owners can extend trips on the fly and view payment status in real time.</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Dedicated admin team validates documents and ensures timely payouts.</li>
                </ul>
                <a href="{{ url_for('owner_cars') }}" class="btn btn-outline-success btn-lg">Start hosting</a>
            </div>
            <div class="col-lg-7">
                <div class="card card-zoom">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Live trip snapshot</h2>
                        <p class="text-muted small">Get realtime status of your fleet's location across every trip.</p>
                        <div class="d-flex gap-4 text-muted small">
                            <div>
                                <div class="fw-bold h4 text-success mb-0">38</div>
                                <span>Trips active today</span>
                            </div>
                            <div>
                                <div class="fw-bold h4 text-success mb-0">12m</div>
                                <span>Average payout / month</span>
                            </div>
                            <div>
                                <div class="fw-bold h4 text-success mb-0">4.8 rating</div>
                                <span>Host satisfaction</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <h2 class="section-title">Popular categories</h2>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            <div class="col">
                <div class="card card-zoom h-100">
                    <img src="{{ url_for('static', filename='img/categories/suv.svg') }}" class="card-img-top category-img" alt="Adventure-ready SUV illustration">
                    <div class="card-body">
                        <h3 class="h5">Adventure-ready SUVs</h3>
                        <p class="text-muted mb-0">Spacious rides with roof carriers, perfect for getaways around Ooty, Coorg or Lonavala.</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card card-zoom h-100">
                    <img src="{{ url_for('static', filename='img/categories/hatchback.svg') }}" class="card-img-top category-img" alt="City hatchback illustration">
                    <div class="card-body">
                        <h3 class="h5">City-smart hatchbacks</h3>
                        <p class="text-muted mb-0">Easy parking, fuel efficient and weekend-friendly drives for two.</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card card-zoom h-100">
                    <img src="{{ url_for('static', filename='img/categories/ev.svg') }}" class="card-img-top category-img" alt="Electric vehicle illustration">
                    <div class="card-body">
                        <h3 class="h5">Electric favourites</h3>
                        <p class="text-muted mb-0">Zero-emission city runs with charging support and fast-pass tolls.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/destination_inputs.js') }}"></script>
<style>
    .city-autocomplete .city-suggestions {
        position: absolute;
        top: calc(100% + 0.25rem);
        left: 0;
        right: 0;
        z-index: 30;
        max-height: 260px;
        overflow-y: auto;
        border-radius: 0.75rem;
        background: #fff;
    }
    .city-autocomplete .city-suggestions .list-group-item {
        cursor: pointer;
        border: none;
        border-bottom: 1px solid rgba(15, 118, 110, 0.08);
    }
    .city-autocomplete .city-suggestions .list-group-item:last-child {
        border-bottom: none;
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
    }
    .city-autocomplete .city-suggestions .list-group-item:first-child {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
    }
    .city-autocomplete .city-suggestions .list-group-item.active,
    .city-autocomplete .city-suggestions .list-group-item:focus,
    .city-autocomplete .city-suggestions .list-group-item:hover {
        background: rgba(13, 159, 92, 0.12);
        color: #0a5c36;
    }
</style>
<script>
    (function () {
        const cityInput = document.getElementById('city');
        const suggestionPanel = document.getElementById('city-suggestions');
        if (!cityInput || !suggestionPanel) {
            return;
        }
        const rawOptions = {{ cities|tojson }};
        const normalised = [];
        const seen = new Set();
        const buildLabel = (item) => item.state ? `${item.name}, ${item.state}` : item.name;
        rawOptions.forEach((city) => {
            if (!city || !city.name) {
                return;
            }
            const key = city.name.trim().toLowerCase();
            if (seen.has(key)) {
                return;
            }
            seen.add(key);
            normalised.push({
                value: city.name.trim(),
                label: buildLabel(city)
            });
        });
        normalised.sort((a, b) => a.label.localeCompare(b.label));
        const MAX_RESULTS = 12;
        let activeIndex = -1;
        let currentResults = [];

        function hideSuggestions() {
            suggestionPanel.classList.add('d-none');
            suggestionPanel.innerHTML = '';
            cityInput.setAttribute('aria-expanded', 'false');
            activeIndex = -1;
            currentResults = [];
        }

        function highlight(index) {
            const items = suggestionPanel.querySelectorAll('[data-value]');
            items.forEach((item, idx) => {
                item.classList.toggle('active', idx === index);
            });
            activeIndex = index;
        }

        function renderSuggestions(term) {
            const query = term.trim().toLowerCase();
            let results;
            if (!query) {
                results = normalised.slice(0, MAX_RESULTS);
            } else {
                results = normalised
                    .filter((option) => option.label.toLowerCase().includes(query))
                    .slice(0, MAX_RESULTS);
            }
            suggestionPanel.innerHTML = '';
            if (!results.length) {
                suggestionPanel.innerHTML = '<div class="list-group-item text-muted small">No matching cities found</div>';
                suggestionPanel.classList.remove('d-none');
                cityInput.setAttribute('aria-expanded', 'true');
                activeIndex = -1;
                currentResults = [];
                return;
            }
            const fragment = document.createDocumentFragment();
            results.forEach((option, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action text-start';
                button.setAttribute('data-value', option.value);
                button.setAttribute('role', 'option');
                button.dataset.index = String(index);
                button.textContent = option.label;
                fragment.appendChild(button);
            });
            suggestionPanel.appendChild(fragment);
            suggestionPanel.classList.remove('d-none');
            cityInput.setAttribute('aria-expanded', 'true');
            activeIndex = -1;
            currentResults = results;
        }

        cityInput.addEventListener('focus', () => {
            renderSuggestions(cityInput.value);
        });
        cityInput.addEventListener('input', () => {
            renderSuggestions(cityInput.value);
        });
        cityInput.addEventListener('keydown', (event) => {
            if (suggestionPanel.classList.contains('d-none')) {
                return;
            }
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (!currentResults.length) {
                    return;
                }
                const nextIndex = activeIndex + 1 >= currentResults.length ? 0 : activeIndex + 1;
                highlight(nextIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (!currentResults.length) {
                    return;
                }
                const prevIndex = activeIndex - 1 < 0 ? currentResults.length - 1 : activeIndex - 1;
                highlight(prevIndex);
            } else if (event.key === 'Enter') {
                if (activeIndex >= 0 && currentResults[activeIndex]) {
                    event.preventDefault();
                    cityInput.value = currentResults[activeIndex].value;
                    hideSuggestions();
                }
            } else if (event.key === 'Escape') {
                hideSuggestions();
            }
        });
        cityInput.addEventListener('blur', () => {
            window.setTimeout(hideSuggestions, 120);
        });
        suggestionPanel.addEventListener('pointerdown', (event) => {
            const target = event.target.closest('[data-value]');
            if (!target) {
                return;
            }
            event.preventDefault();
            cityInput.value = target.getAttribute('data-value');
            hideSuggestions();
        });
    })();
</script>
<script>
    const detectBtn = document.getElementById('detect-location');
    const latField = document.getElementById('search-lat');
    const lngField = document.getElementById('search-lng');
    const startField = document.getElementById('start_time');
    const endField = document.getElementById('end_time');

    function pad(value) {
        return value.toString().padStart(2, '0');
    }

    function formatDate(date) {
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    if (startField && !startField.value) {
        const now = new Date();
        now.setMinutes(0, 0, 0);
        const start = new Date(now.getTime() + 60 * 60 * 1000);
        const end = new Date(start.getTime() + 4 * 60 * 60 * 1000);
        startField.value = formatDate(start);
        if (endField && !endField.value) {
            endField.value = formatDate(end);
        }
    }

    if (detectBtn && navigator.geolocation) {
        detectBtn.addEventListener('click', () => {
            detectBtn.disabled = true;
            detectBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Locating...';
            navigator.geolocation.getCurrentPosition((position) => {
                latField.value = position.coords.latitude.toFixed(6);
                lngField.value = position.coords.longitude.toFixed(6);
                detectBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Location set';
                detectBtn.classList.remove('btn-outline-success');
                detectBtn.classList.add('btn-success');
            }, () => {
                alert('Unable to detect location. Please allow access or set it later on the map.');
                detectBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Use my location';
                detectBtn.disabled = false;
            });
        });
    } else if (detectBtn) {
        detectBtn.style.display = 'none';
    }
</script>
{% endblock %}
