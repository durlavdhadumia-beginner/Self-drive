{% extends "base.html" %}
{% block title %}Host Dashboard | DriveNow{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
    <style>
        .host-location-map {
            height: 280px;
            min-height: 280px;
            width: 100%;
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.4), rgba(209, 250, 229, 0.2));
        }
    </style>
{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1">Host dashboard</h1>
                <p class="text-muted mb-0">Track your fleet, respond to bookings, and close trips.</p>
            </div>
            <div class="bg-white shadow-sm rounded-4 px-4 py-3 d-flex gap-4">
                <div>
                    <div class="small text-uppercase text-muted fw-semibold">Active rentals</div>
                    <div class="fw-bold fs-5 text-success">{{ rentals|selectattr('status', 'equalto', 'active')|list|length }}</div>
                </div>
                <div>
                    <div class="small text-uppercase text-muted fw-semibold">Pending requests</div>
                    <div class="fw-bold fs-5 text-success">{{ rentals|selectattr('owner_response', 'equalto', 'pending')|list|length }}</div>
                </div>
            </div>
        </div>

        <div class="card card-zoom mb-4">
            <div class="card-body">
                <h2 class="h5 fw-semibold mb-3">Need to raise a complaint or share feedback?</h2>
                <p class="text-muted small mb-3">Flag concerns about renters, vehicle condition on return, payouts, or any platform issues. Our support desk will step in quickly.</p>
                <form class="row g-3 align-items-end" method="post" action="{{ url_for('submit_feedback') }}">
                    <input type="hidden" name="redirect_endpoint" value="owner_cars">
                    <input type="hidden" name="feedback_role" value="owner">
                    <div class="col-md-4">
                        <label class="form-label small" for="host-feedback-trip">Booking (optional)</label>
                        <select class="form-select" id="host-feedback-trip" name="rental_id">
                            <option value="" selected>General platform feedback</option>
                            {% for rental in rentals %}
                                <option value="{{ rental['id'] }}">
                                    {{ rental['car_name'] }} with {{ rental['renter_username'] }} ({{ rental['start_time'] }} to {{ rental['end_time'] or 'TBD' }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small" for="host-feedback-category">Category</label>
                        <select class="form-select" id="host-feedback-category" name="category">
                            <option value="Platform issue">Platform issue</option>
                            <option value="Vehicle damage">Vehicle damage</option>
                            <option value="Late return">Late return</option>
                            <option value="Payment concern">Payment concern</option>
                            <option value="Renter conduct">Renter conduct</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label small" for="host-feedback-description">Describe the issue</label>
                        <textarea class="form-control" id="host-feedback-description" name="description" rows="2" placeholder="Provide context so we can assist" required></textarea>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-outline-success">Send to support</button>
                    </div>
                </form>
            </div>
        </div>

        {% if pending_payments %}
        <div class="alert alert-info d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-4">
            {% set pending_total = pending_payments|sum(attribute='total_amount') %}
            <div>
                <strong>{{ pending_payments|length }} payout{% if pending_payments|length > 1 %}s{% endif %} pending.</strong> DriveNow receives each customer payment, retains a 5% service fee, and then schedules the remaining 95% for your account.
            </div>
            <div class="text-muted small">Latest request total: Rs {{ pending_total|round|int }} - Your take-home: Rs {{ (pending_total * (1 - commission_rate / 100))|round(2) }}</div>
        </div>
        {% endif %}
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">My listed vehicles</h2>
                        {% if cars %}
                        <div class="list-group list-group-flush">
                            {% for car in cars %}
                            <div class="list-group-item py-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h3 class="h5 mb-1">{{ car['name'] or car['brand'] ~ ' ' ~ car['model'] }}</h3>
                                        <p class="text-muted small mb-0">{{ car['brand'] }} {{ car['model'] }} - {{ car['city'] or 'City not set' }}</p>
                                    </div>
                                    <span class="badge {{ 'bg-success' if car['is_available'] else 'bg-secondary' }}">
                                        {{ 'Available' if car['is_available'] else 'Unavailable' }}
                                    </span>
                                </div>
                                {% if car['images'] %}
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    {% for image in car['images'] %}
                                    <img src="{{ (image if image.lower().startswith('http') else url_for('serve_upload', filename=image)) }}"
                                        alt="{{ car['name'] }}" class="rounded"
                                        style="width:96px;height:64px;object-fit:cover;">
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="row text-muted small mb-3">
                                    <div class="col-sm-6">Licence: {{ car['licence_plate'] }}</div>
                                    <div class="col-sm-6">Seats: {{ car['seats'] }}</div>
                                    <div class="col-sm-6">Hourly rate: Rs {{ '%.0f'|format(car['rate_per_hour']) }}</div>
                                    <div class="col-sm-6">Daily rate: Rs {{ '%.0f'|format(car['daily_rate']) }}</div>
                                    <div class="col-sm-6">Fuel type: {{ car['fuel_type'] or 'NA' }}</div>
                                    <div class="col-sm-6">Transmission: {{ car['transmission'] or 'NA' }}</div>
                                </div>
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <form method="post" action="{{ url_for('owner_toggle_availability', car_id=car['id']) }}">
                                        <button type="submit"
                                            class="btn btn-sm {{ 'btn-outline-secondary' if car['is_available'] else 'btn-outline-success' }}">
                                            {% if car['is_available'] %}Mark unavailable{% else %}Mark available{% endif %}
                                        </button>
                                    </form>
                                    <form method="post" action="{{ url_for('owner_update_location', car_id=car['id']) }}"
                                        class="d-flex flex-wrap gap-2">
                                        <input type="text" class="form-control form-control-sm" name="latitude"
                                            placeholder="Latitude" required>
                                        <input type="text" class="form-control form-control-sm" name="longitude"
                                            placeholder="Longitude" required>
                                        <button type="submit" class="btn btn-sm btn-outline-success">Update GPS</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">You have not listed any cars yet. Add your first car to start hosting.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
                        <div class="col-lg-5">
                <div class="card card-zoom mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">List a new vehicle</h2>
                        <form method="post" action="{{ url_for('owner_add_car') }}" enctype="multipart/form-data" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="vehicle_type">Vehicle type</label>
                                <select class="form-select" id="vehicle_type" name="vehicle_type" required>
                                    <option value="">Select type</option>
                                    {% for label in popular_vehicle_types %}
                                        <option value="{{ label }}">{{ label }}</option>
                                    {% endfor %}
                                    {% for label in other_vehicle_types %}
                                        <option value="{{ label }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="size_category">Size category</label>
                                <input type="text" class="form-control" id="size_category" name="size_category" placeholder="Compact / Cruiser">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="name">Listing name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="e.g. Swift Automatic">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="brand">Brand</label>
                                <input type="text" class="form-control" id="brand" name="brand" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="model">Model</label>
                                <input type="text" class="form-control" id="model" name="model" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="licence_plate">Registration number</label>
                                <input type="text" class="form-control" id="licence_plate" name="licence_plate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="seats">Seats</label>
                                <input type="number" class="form-control" id="seats" name="seats" min="1" max="12" value="4">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="rate_unit">Rate type</label>
                                <select class="form-select" id="rate_unit" name="rate_unit">
                                    <option value="hour" selected>Per hour</option>
                                    <option value="day">Per day</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="rate_amount">Rate amount (&#8377;)</label>
                                <input type="number" class="form-control" id="rate_amount" name="rate_amount" min="0" step="1" value="350">
                                <div class="form-text">We auto-calculate the complementary daily or hourly price.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="fuel_type">Fuel type</label>
                                <input type="text" class="form-control" id="fuel_type" name="fuel_type" placeholder="Select or type" list="fuel-type-options" autocomplete="off">
                                <datalist id="fuel-type-options">
                                    {% for fuel in fuel_types %}
                                        <option value="{{ fuel }}"></option>
                                    {% endfor %}
                                </datalist>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="transmission">Transmission</label>
                                <input type="text" class="form-control" id="transmission" name="transmission" placeholder="Manual / Automatic">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="city">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="Start typing a city" autocomplete="off" list="owner-city-options">
                                <datalist id="owner-city-options">
                                    {% for entry in city_entries %}
                                        {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
                                        <option value="{{ label }}"></option>
                                    {% endfor %}
                                </datalist>
                                <div class="form-text">Pick a city from the list. If it isn&#39;t there, drop a pin on the map below.</div>
                            </div>
                            <div class="col-12">
                                <div id="owner-map" class="host-location-map rounded-4 border"></div>
                                <div class="form-text">Click anywhere on the map to position this vehicle accurately.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="latitude">Latitude</label>
                                <input type="text" class="form-control" id="latitude" name="latitude" placeholder="12.9716" required inputmode="decimal" autocomplete="off">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="longitude">Longitude</label>
                                <input type="text" class="form-control" id="longitude" name="longitude" placeholder="77.5946" required inputmode="decimal" autocomplete="off">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vehicle_has_gps" name="has_gps" {% if g.profile and g.profile.get('gps_tracking') %}checked{% endif %}>
                                    <label class="form-check-label" for="vehicle_has_gps">This vehicle has a GPS device installed</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="image_url">Primary image URL</label>
                                <input type="url" class="form-control" id="image_url" name="image_url" placeholder="https://...">
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="photos">Upload gallery images</label>
                                <div id="photo-input-list" class="d-flex flex-column gap-2">
                                    <div class="input-group photo-input-row" data-role="photo-input-row">
                                        <input type="file" class="form-control" id="photos" name="photos" accept="image/*" aria-label="Gallery image 1">
                                        <button type="button" class="btn btn-outline-danger" data-role="remove-photo" title="Remove image">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text mb-0">Upload up to 8 images (PNG, JPG, GIF, WEBP).</div>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="add-photo-input">
                                        <i class="bi bi-plus-circle"></i> Add another
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="description">Highlights</label>
                                <textarea class="form-control" id="description" name="description" rows="3" placeholder="Mention delivery options, add-ons, insurance, etc."></textarea>
                            </div>
                            <div class="col-12 d-grid">
                                <button type="submit" class="btn btn-success">List vehicle</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card card-zoom mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Pending booking requests</h2>
                        {% set pending_requests = rentals|selectattr('owner_response', 'equalto', 'pending')|list %}
                        {% set counter_requests = rentals|selectattr('owner_response', 'equalto', 'counter')|list %}
                        {% if pending_requests or counter_requests %}
                            {% for rental in pending_requests %}
                                <div class="border rounded-4 p-3 mb-3">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small mb-2">Start {{ rental['start_time'] }} ? {{ rental['end_time'] or 'TBD' }}</div>
                                    <div class="text-muted small mb-3">Offer total: Rs {{ rental['total_amount']|round|int }}</div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <form method="post" action="{{ url_for('owner_respond_rental', rental_id=rental['id']) }}">
                                            <input type="hidden" name="action" value="accept">
                                            <button type="submit" class="btn btn-sm btn-success">Accept</button>
                                        </form>
                                        <form method="post" action="{{ url_for('owner_respond_rental', rental_id=rental['id']) }}" class="d-flex gap-2">
                                            <input type="hidden" name="action" value="reject">
                                            <input type="text" class="form-control form-control-sm" name="reason" placeholder="Reason" required>
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Reject</button>
                                        </form>
                                        <form method="post" action="{{ url_for('owner_respond_rental', rental_id=rental['id']) }}" class="d-flex gap-2">
                                            <input type="hidden" name="action" value="counter">
                                            <input type="number" class="form-control form-control-sm" name="counter_amount" placeholder="New total" min="0" step="50" required>
                                            <input type="text" class="form-control form-control-sm" name="counter_comment" placeholder="Note (optional)">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary">Counter once</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                            {% for rental in counter_requests %}
                                <div class="border rounded-4 p-3 mb-3 bg-warning-subtle">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small">Waiting for renter to respond to your counter offer of Rs {{ rental['counter_amount']|round|int }}.</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No new booking requests right now.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card card-zoom mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Awaiting payment</h2>
                        {% set awaiting = rentals|selectattr('payment_status', 'equalto', 'awaiting_payment')|list %}
                        {% if awaiting %}
                            {% for rental in awaiting %}
                                <div class="border rounded-4 p-3 mb-3">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small mb-2">Total due Rs {{ rental['total_amount']|round|int }} by {{ rental['payment_due_at'] or 'n/a' }}</div>
                                    <div class="text-muted small">We have alerted the renter. You will be notified once payment is confirmed.</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No pending payments from renters.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card card-zoom mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Trips in progress</h2>
                        {% set active_trips = rentals|selectattr('status', 'equalto', 'active')|list %}
                        {% set ready_to_start = rentals|selectattr('status', 'equalto', 'booked')|selectattr('owner_response', 'equalto', 'accepted')|selectattr('payment_status', 'equalto', 'paid')|list %}
                        {% if active_trips or ready_to_start %}
                            {% for rental in ready_to_start %}
                                <div class="border rounded-4 p-3 mb-3">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small mb-2">Payment confirmed. Mark the trip as started when you hand over the car.</div>
                                    <form method="post" action="{{ url_for('owner_start_rental', rental_id=rental['id']) }}">
                                        <button type="submit" class="btn btn-sm btn-success">Mark trip started</button>
                                    </form>
                                </div>
                            {% endfor %}
                            {% for rental in active_trips %}
                                <div class="border rounded-4 p-3 mb-3">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small">Started {{ rental['owner_started_at'] or rental['start_time'] }}</div>
                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                        <form method="post" action="{{ url_for('owner_extend_rental', rental_id=rental['id']) }}" class="d-flex gap-2">
                                            <input type="number" class="form-control form-control-sm" name="extra_hours" min="1" placeholder="Extra hours" required>
                                            <button type="submit" class="btn btn-sm btn-outline-secondary">Extend trip</button>
                                        </form>
                                        <form method="post" action="{{ url_for('owner_complete_rental', rental_id=rental['id']) }}">
                                            <button type="submit" class="btn btn-sm btn-outline-success">Mark completed</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No live trips at the moment. Your cars are ready for new bookings.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card card-zoom">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Completed trips awaiting review</h2>
                        {% set completed_trips = rentals|selectattr('status', 'equalto', 'completed')|list %}
                        {% if completed_trips %}
                            {% for rental in completed_trips %}
                                <div class="border rounded-4 p-3 mb-3">
                                    <div class="fw-semibold">{{ rental['car_name'] }} - {{ rental['renter_username'] }}</div>
                                    <div class="text-muted small mb-2">Ended {{ rental['completed_at'] or rental['end_time'] }}</div>
                                    <form method="post" action="{{ url_for('owner_review_rental', rental_id=rental['id']) }}" class="row g-2">
                                        <div class="col-4">
                                            <label class="form-label small" for="passenger_rating_{{ rental['id'] }}">Passenger rating</label>
                                            <input type="number" class="form-control form-control-sm" id="passenger_rating_{{ rental['id'] }}" name="passenger_rating" min="1" max="5" required>
                                        </div>
                                        <div class="col-8">
                                            <label class="form-label small" for="comment_{{ rental['id'] }}">Comment</label>
                                            <input type="text" class="form-control form-control-sm" id="comment_{{ rental['id'] }}" name="comment" placeholder="Optional feedback">
                                        </div>
                                        <div class="col-12 d-grid">
                                            <button type="submit" class="btn btn-sm btn-outline-success">Submit review</button>
                                        </div>
                                    </form>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No trips waiting for reviews.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const photoContainer = document.getElementById('photo-input-list');
            const addPhotoBtn = document.getElementById('add-photo-input');
            const MAX_PHOTOS = 8;
            const attachRowHandlers = (row) => {
                const input = row.querySelector('input[type="file"]');
                const removeBtn = row.querySelector('[data-role="remove-photo"]');
                if (input) {
                    input.addEventListener('change', () => ensureSpareSlot());
                }
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        const rows = photoContainer.querySelectorAll('[data-role="photo-input-row"]');
                        if (rows.length === 1) {
                            if (input) {
                                input.value = '';
                            }
                            updatePhotoControls();
                            return;
                        }
                        row.remove();
                        ensureSpareSlot();
                    });
                }
            };
            const updatePhotoControls = () => {
                if (!photoContainer || !addPhotoBtn) {
                    return;
                }
                const rows = photoContainer.querySelectorAll('[data-role="photo-input-row"]');
                const canAdd = rows.length < MAX_PHOTOS;
                addPhotoBtn.disabled = !canAdd;
                rows.forEach((row) => {
                    const removeBtn = row.querySelector('[data-role="remove-photo"]');
                    if (removeBtn) {
                        removeBtn.disabled = rows.length === 1;
                    }
                });
            };
            const addPhotoRow = (focusInput = true) => {
                if (!photoContainer) {
                    return;
                }
                const currentCount = photoContainer.querySelectorAll('[data-role="photo-input-row"]').length;
                if (currentCount >= MAX_PHOTOS) {
                    updatePhotoControls();
                    return;
                }
                const row = document.createElement('div');
                row.className = 'input-group photo-input-row';
                row.dataset.role = 'photo-input-row';
                const input = document.createElement('input');
                input.type = 'file';
                input.name = 'photos';
                input.accept = 'image/*';
                input.className = 'form-control';
                input.setAttribute('aria-label', `Gallery image ${currentCount + 1}`);
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-outline-danger';
                removeBtn.dataset.role = 'remove-photo';
                removeBtn.title = 'Remove image';
                removeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                row.appendChild(input);
                row.appendChild(removeBtn);
                photoContainer.appendChild(row);
                attachRowHandlers(row);
                updatePhotoControls();
                if (focusInput) {
                    input.focus();
                }
            };
            const ensureSpareSlot = () => {
                if (!photoContainer) {
                    return;
                }
                const rows = photoContainer.querySelectorAll('[data-role="photo-input-row"]');
                const hasEmpty = Array.from(rows).some((row) => {
                    const input = row.querySelector('input[type="file"]');
                    return input && input.files && input.files.length === 0;
                });
                if (!hasEmpty && rows.length < MAX_PHOTOS) {
                    addPhotoRow(false);
                } else {
                    updatePhotoControls();
                }
            };
            if (photoContainer && addPhotoBtn) {
                Array.from(photoContainer.querySelectorAll('[data-role="photo-input-row"]')).forEach(attachRowHandlers);
                addPhotoBtn.addEventListener('click', () => {
                    addPhotoRow();
                    ensureSpareSlot();
                });
                ensureSpareSlot();
            }
            const mapElement = document.getElementById('owner-map');
            if (!mapElement || typeof L === 'undefined') {
                return;
            }
            const cityInput = document.getElementById('city');
            const latitudeField = document.getElementById('latitude');
            const longitudeField = document.getElementById('longitude');
            const cityEntries = {{ city_entries|tojson|safe }};
            const buildLabel = (entry) => {
                const name = (entry.name || '').trim();
                const state = (entry.state || '').trim();
                return state ? `${name}, ${state}` : name;
            };
            const findCity = (label) => {
                if (!label) {
                    return null;
                }
                const normalised = label.trim().toLowerCase();
                return cityEntries.find((entry) => buildLabel(entry).toLowerCase() === normalised) || null;
            };
            const DEFAULT_VIEW = { lat: 20.5937, lng: 78.9629, zoom: 5 };
            const map = L.map(mapElement, { zoomControl: true });
            map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors'
            }).addTo(map);
            let marker = null;
            const ensureMapSize = () => map.invalidateSize();
            map.whenReady(() => {
                ensureMapSize();
                setTimeout(ensureMapSize, 150);
            });
            window.addEventListener('resize', ensureMapSize);
            const setMarker = (lat, lng) => {
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                    return;
                }
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    marker.on('dragend', (event) => {
                        const pos = event.target.getLatLng();
                        latitudeField.value = pos.lat.toFixed(6);
                        longitudeField.value = pos.lng.toFixed(6);
                    });
                }
                latitudeField.value = lat.toFixed(6);
                longitudeField.value = lng.toFixed(6);
            };
            const focusOn = (lat, lng, zoom = 13) => {
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                    return;
                }
                map.setView([lat, lng], zoom);
                setMarker(lat, lng);
            };
            const handleCitySelection = () => {
                const entry = findCity(cityInput.value);
                if (entry && Number.isFinite(entry.latitude) && Number.isFinite(entry.longitude)) {
                    focusOn(entry.latitude, entry.longitude, 11);
                }
            };
            if (cityInput) {
                cityInput.addEventListener('change', handleCitySelection);
                cityInput.addEventListener('blur', handleCitySelection);
            }
            map.on('click', (event) => {
                focusOn(event.latlng.lat, event.latlng.lng);
            });
            const latExisting = parseFloat(latitudeField.value);
            const lngExisting = parseFloat(longitudeField.value);
            if (Number.isFinite(latExisting) && Number.isFinite(lngExisting)) {
                focusOn(latExisting, lngExisting);
            } else {
                handleCitySelection();
            }
        });
    </script>
{% endblock %}

