{% extends "base.html" %}
{% block title %}Host Dashboard | DriveNow{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1">Host dashboard</h1>
                <p class="text-muted mb-0">Track your fleet, update availability, and close trips.</p>
            </div>
            <div class="bg-white shadow-sm rounded-4 px-4 py-3">
                <div class="small text-uppercase text-muted fw-semibold">Active rentals</div>
                <div class="fw-bold fs-4 text-success">{{ rentals|length }}</div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card card-zoom h-100">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">My listed cars</h2>
                        {% if cars %}
                            <div class="list-group list-group-flush">
                                {% for car in cars %}
                                    <div class="list-group-item py-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h3 class="h5 mb-1">{{ car['name'] or car['brand'] ~ ' ' ~ car['model'] }}</h3>
                                                <p class="text-muted small mb-0">{{ car['brand'] }} {{ car['model'] }} · {{ car['city'] or 'City not set' }}</p>
                                            </div>
                                            <span class="badge {{ 'bg-success' if car['is_available'] else 'bg-secondary' }}">
                                                {{ 'Available' if car['is_available'] else 'Unavailable' }}
                                            </span>
                                        </div>
                                        {% if car['images'] %}
                                            <div class="d-flex flex-wrap gap-2 mb-3">
                                                {% for image in car['images'] %}
                                                    <img src="{{ (image if image.lower().startswith('http') else url_for('serve_upload', filename=image)) }}" alt="{{ car['name'] }}" class="rounded" style="width:96px;height:64px;object-fit:cover;">
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="row text-muted small mb-3">
                                            <div class="col-sm-6">Licence: {{ car['licence_plate'] }}</div>
                                            <div class="col-sm-6">Seats: {{ car['seats'] }}</div>
                                            <div class="col-sm-6">Hourly rate: ?{{ '%.0f'|format(car['rate_per_hour']) }}</div>
                                            <div class="col-sm-6">Daily rate: ?{{ '%.0f'|format(car['daily_rate']) }}</div>
                                            <div class="col-sm-6">Fuel type: {{ car['fuel_type'] or 'NA' }}</div>
                                            <div class="col-sm-6">Transmission: {{ car['transmission'] or 'NA' }}</div>
                                        </div>
                                        <div class="d-flex flex-wrap gap-3 align-items-center">
                                            <form method="post" action="{{ url_for('owner_toggle_availability', car_id=car['id']) }}">
                                                <button type="submit" class="btn btn-sm {{ 'btn-outline-secondary' if car['is_available'] else 'btn-outline-success' }}">
                                                    {% if car['is_available'] %}Mark unavailable{% else %}Mark available{% endif %}
                                                </button>
                                            </form>
                                            <form method="post" action="{{ url_for('owner_update_location', car_id=car['id']) }}" class="d-flex flex-wrap gap-2">
                                                <input type="text" class="form-control form-control-sm" name="latitude" placeholder="Latitude" required>
                                                <input type="text" class="form-control form-control-sm" name="longitude" placeholder="Longitude" required>
                                                <button type="submit" class="btn btn-sm btn-outline-success">Update GPS</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">You haven't listed any cars yet. Use the form to add your first vehicle.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card card-zoom mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Add a new car</h2>
                        <form method="post" action="{{ url_for('owner_add_car') }}" class="row gy-3" enctype="multipart/form-data">
                            <div class="col-12">
                                <label class="form-label" for="name">Listing name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="e.g. EcoSport Urban Cruiser" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="brand">Brand</label>
                                <input type="text" class="form-control" id="brand" name="brand" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="model">Model</label>
                                <input type="text" class="form-control" id="model" name="model" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="licence_plate">Licence plate</label>
                                <input type="text" class="form-control" id="licence_plate" name="licence_plate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="city">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="e.g. Bengaluru" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="fuel_type">Fuel type</label>
                                <input type="text" class="form-control" id="fuel_type" name="fuel_type" placeholder="Petrol / Diesel / EV">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="transmission">Transmission</label>
                                <input type="text" class="form-control" id="transmission" name="transmission" placeholder="Manual / Automatic">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="seats">Seats</label>
                                <input type="number" class="form-control" id="seats" name="seats" min="1" max="12" value="5">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="rate_per_hour">Rate/hr (?)</label>
                                <input type="number" step="0.5" class="form-control" id="rate_per_hour" name="rate_per_hour" value="350">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="daily_rate">Rate/day (?)</label>
                                <input type="number" step="0.5" class="form-control" id="daily_rate" name="daily_rate" placeholder="Auto-calculated if blank">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="latitude">Latitude</label>
                                <input type="text" class="form-control" id="latitude" name="latitude" placeholder="12.9716" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="longitude">Longitude</label>
                                <input type="text" class="form-control" id="longitude" name="longitude" placeholder="77.5946" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="image_url">Primary image URL</label>
                                <input type="url" class="form-control" id="image_url" name="image_url" placeholder="https://...">
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="photos">Upload gallery images</label>
                                <input type="file" class="form-control" id="photos" name="photos" accept="image/*" multiple>
                                <div class="form-text">Upload up to 10 images (PNG, JPG, GIF, WEBP). We'll resize automatically.</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="description">Description / highlights</label>
                                <textarea class="form-control" id="description" name="description" rows="3" placeholder="Mention delivery options, add-ons, insurance, etc."></textarea>
                            </div>
                            <div class="col-12 d-grid">
                                <button type="submit" class="btn btn-success">List car</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card card-zoom">
                    <div class="card-body">
                        <h2 class="h5 fw-semibold mb-3">Trips in progress</h2>
                        {% if rentals %}
                            <div class="list-group list-group-flush">
                                {% for rental in rentals %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-semibold">{{ rental['brand'] }} {{ rental['model'] }}</div>
                                                <div class="text-muted small">Renter: {{ rental['renter_username'] }} · Started {{ rental['start_time'] }}</div>
                                            </div>
                                            <form method="post" action="{{ url_for('owner_complete_rental', rental_id=rental['id']) }}">
                                                <button type="submit" class="btn btn-sm btn-outline-success">Mark completed</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">No live trips at the moment. Your cars are ready for new bookings.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
