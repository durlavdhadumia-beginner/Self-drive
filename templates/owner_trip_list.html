{% extends "base.html" %}
{% block title %}Host Trips | DriveNow{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1">{{ title }}</h1>
                {% if description %}
                <p class="text-muted mb-0">{{ description }}</p>
                {% endif %}
            </div>
            <a href="{{ url_for('owner_cars') }}" class="btn btn-outline-secondary">&larr; Back to dashboard</a>
        </div>

        {% if trips %}
        <div class="list-group shadow-sm">
            {% for trip in trips %}
            {% set car = cars_by_id.get(trip['car_id']) %}
            <div class="list-group-item px-4 py-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-3">
                    <div>
                        <h2 class="h5 mb-1">
                            {{ trip['car_name'] or (car and car['name']) or (car and (car['brand'] ~ ' ' ~ car['model'])) or 'Vehicle' }}
                            <span class="text-muted fw-normal"> &mdash; {{ trip['renter_public_name'] }}</span>
                        </h2>
                        {% if trip['booking_identifier'] %}
                            <div class="text-muted small">Booking ID: {{ trip['booking_identifier'] }}</div>
                        {% else %}
                            <div class="text-muted small">Booking ID: #{{ trip['id'] }}</div>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-info text-dark text-uppercase small">{{ (trip['status'] or 'unknown')|replace('_', ' ') }}</span>
                        <span class="badge bg-secondary text-uppercase small">{{ (trip['payment_status'] or 'pending')|replace('_', ' ') }}</span>
                        {% if trip['owner_response'] == 'pending' %}
                            <span class="badge bg-warning text-dark text-uppercase small">{{ trip['owner_response']|replace('_', ' ') }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <h3 class="h6 text-uppercase text-muted fw-semibold">Trip details</h3>
                        <ul class="list-unstyled mb-0 text-muted small">
                            <li><span class="fw-semibold text-dark">Start:</span> {{ trip['start_time']|trip_datetime }}</li>
                            <li><span class="fw-semibold text-dark">End:</span> {{ trip['end_time']|trip_datetime if trip['end_time'] else 'TBD' }}</li>
                            <li><span class="fw-semibold text-dark">Trip type:</span> {{ trip['delivery_type']|replace('_', ' ')|title }}</li>
                            {% if trip['delivery_type'] == 'delivery' %}
                                <li><span class="fw-semibold text-dark">Delivery distance:</span>
                                    {% if trip['delivery_distance_km'] %}~{{ trip['delivery_distance_km']|round(1) }} km{% else %}Not provided{% endif %}
                                </li>
                            {% endif %}
                            {% if trip['trip_destinations_list'] %}
                                <li>
                                    <span class="fw-semibold text-dark">Destinations:</span>
                                    {{ trip['trip_destinations_list']|join(', ') }}
                                </li>
                            {% endif %}
                            {% if car and car['has_gps'] and trip['car_latitude'] is not none and trip['car_longitude'] is not none %}
                                <li><span class="fw-semibold text-dark">Vehicle location:</span> {{ trip['car_latitude']|round(5) }}, {{ trip['car_longitude']|round(5) }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h6 text-uppercase text-muted fw-semibold">Payment summary</h3>
                        <ul class="list-unstyled mb-0 text-muted small">
                            <li><span class="fw-semibold text-dark">Rental:</span> Rs {{ (trip['host_rental_amount'] or 0)|round(2) }}</li>
                            <li><span class="fw-semibold text-dark">Delivery:</span> Rs {{ (trip['delivery_fee'] or 0)|round(2) }}</li>
                            <li><span class="fw-semibold text-dark">Service fee ({{ service_fee_rate }}%):</span> -Rs {{ (trip['host_service_fee'] or 0)|round(2) }}</li>
                            <li class="fw-semibold text-success">Net take-home: Rs {{ (trip['host_net_take_home'] or 0)|round(2) }}</li>
                            <li><span class="fw-semibold text-dark">Received so far:</span> Rs {{ (trip['host_amount_received'] or 0)|round(2) }}</li>
                            <li><span class="fw-semibold text-dark">Balance pending:</span> Rs {{ (trip['host_amount_balance'] or 0)|round(2) }}</li>
                            <li><span class="fw-semibold text-dark">Payment status:</span> {{ trip['payment_status']|replace('_',' ')|title }}</li>
                        </ul>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="alert alert-info">No trips match this view at the moment.</div>
        {% endif %}
    </div>
</section>
{% endblock %}
