{% extends "base.html" %}
{% block title %}Find Vehicles | DriveNow{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
    <style>
        #map {
            height: 420px;
            min-height: 420px;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 25px 45px rgba(15, 118, 110, 0.12);
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.6), rgba(209, 250, 229, 0.3));
            position: relative;
        }
        .leaflet-container {
            font-family: "Inter", sans-serif;
        }
        .leaflet-container img.leaflet-image-layer,
        .leaflet-container img.leaflet-tile {
            max-width: none !important;
            max-height: none !important;
        }
        .car-card {
            border: none;
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(15, 118, 110, 0.08);
            transition: box-shadow 0.3s ease;
        }
        .car-card.ring-highlight {
            box-shadow: 0 0 0 0.35rem rgba(13, 159, 92, 0.35), 0 26px 52px rgba(15, 118, 110, 0.15);
        }
        .car-card img {
            height: 190px;
            width: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .car-gallery-trigger {
            cursor: pointer;
        }
        .object-fit-cover {
            object-fit: cover;
        }
        .map-car-icon,
        .map-pickup-icon {
            background: transparent;
            border: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .map-car-icon-pin,
        .map-pickup-icon-pin {
            display: block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid #ffffff;
            box-shadow: 0 6px 12px rgba(15, 118, 110, 0.25);
            position: relative;
        }
        .map-car-icon-pin::after,
        .map-pickup-icon-pin::after {
            content: "";
            position: absolute;
            bottom: -9px;
            left: 50%;
            margin-left: -7px;
            width: 0;
            height: 0;
            border: 7px solid transparent;
            border-top-color: currentColor;
        }
        .map-car-icon-pin {
            background: #0d9f5c;
            color: #0d9f5c;
        }
        .map-pickup-icon-pin {
            background: #facc15;
            color: #facc15;
        }
        .delivery-map {
            height: 220px;
            min-height: 220px;
            border-radius: 1rem;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.65), rgba(209, 250, 229, 0.4));
        }
        .modal-gallery-img {
            height: 420px;
            object-fit: cover;
        }
        .rating {
            color: #facc15;
        }
        .filter-bar {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(15,118,110,0.08);
            padding: 1.5rem;
        }
        .vehicle-type-field {
            position: relative;
            position: relative;
        }
        .vehicle-type-field .vehicle-type-select {
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 0.5rem 2.25rem 0.5rem 0.85rem;
            font-size: 1rem;
            font-weight: 400;
            color: #0f172a;
            height: auto;
            box-shadow: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .vehicle-type-field .vehicle-type-select:focus {
            border-color: #0d9f5c;
            box-shadow: 0 0 0 0.25rem rgba(13, 159, 92, 0.15);
        }
        .vehicle-photo-placeholder {
            height: 190px;
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.65), rgba(209, 250, 229, 0.4));
            color: rgba(15, 118, 110, 0.5);
            font-size: 2rem;
        }
        .vehicle-photo-placeholder i {
            opacity: 0.6;
        }
    </style>
{% endblock %}
{% block content %}
<section class="py-4">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1">Select your pickup point</h1>
                <p class="text-muted mb-0">Drag the pin or tap the map. Refine filters to see vehicles that suit your drive.</p>
            </div>
            <div class="bg-white shadow-sm rounded-4 px-4 py-3">
                <div class="small text-uppercase text-muted fw-semibold">Trip summary</div>
                <div class="fw-semibold">City: {{ city_display or detected_city or '-' }}</div>
                <div class="text-muted">Start: {{ start_time_display }}</div>
                <div class="text-muted">End: {{ end_time_display }}</div>
                {% if destinations %}
                    <div class="text-muted">Destinations: {{ destinations|join(', ') }}</div>
                {% endif %}
            </div>
        </div>

        {% if detected_city %}
            <div class="alert alert-success" role="alert">
                We detected <strong>{{ detected_city }}</strong> based on your map selection. Adjust if you prefer another city.
            </div>
        {% endif %}

        {% if profile_warning %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ profile_warning }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="card card-zoom mb-5">
            <div class="card-body">
                <form method="post" id="search-form" class="row g-3 align-items-end">
                    <input type="hidden" name="latitude" id="latitude-field" value="{{ latitude if latitude is not none else '' }}">
                    <input type="hidden" name="longitude" id="longitude-field" value="{{ longitude if longitude is not none else '' }}">
                    {% set selected_vehicle_type = filters.vehicle_types|first if filters.vehicle_types else '' %}
                    <div class="col-12">
                        <div id="map"></div>
                    </div>
                    <div class="col-12">
                        <div class="filter-bar">
                            <div class="row g-3 align-items-end">
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="city-field">City</label>
                                    <input type="text" class="form-control" name="city" id="city-field" value="{{ city or detected_city or '' }}" placeholder="e.g. Bengaluru" list="city-options">
                                    {% if city_entries %}
                                        <datalist id="city-options">
                                            {% for entry in city_entries %}
                                                {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
                                                <option value="{{ label }}">
                                            {% endfor %}
                                        </datalist>
                                        <datalist id="destination-options">
                                            {% for entry in city_entries %}
                                                {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
                                                <option value="{{ label }}">
                                            {% endfor %}
                                        </datalist>
                                    {% endif %}
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="start-field">Trip start</label>
                                    <input type="datetime-local" class="form-control" name="start_time" id="start-field" value="{{ start_time or '' }}" required>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="end-field">Trip end</label>
                                    <input type="datetime-local" class="form-control" name="end_time" id="end-field" value="{{ end_time or '' }}" required>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="radius">Radius (km)</label>
                                    <input type="number" class="form-control" name="radius" id="radius" min="1" max="200" step="1" value="{{ radius or 10 }}">
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="form-label" for="destinations-0">Trip destinations</label>
                                    <div class="d-flex flex-column gap-2"
                                         data-destination-container
                                         data-input-name="destinations"
                                         data-add-button="#add-search-destination"
                                         data-datalist="destination-options"
                                         data-required="true"
                                         data-initial="{{ destinations|tojson|safe }}">
                                        {% for destination in destinations %}
                                            <div class="input-group destination-input-row" data-role="destination-input-row">
                                                <input type="text" class="form-control" name="destinations" value="{{ destination }}" placeholder="Enter destination" autocomplete="off">
                                                <button type="button" class="btn btn-outline-danger" data-role="remove-destination">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div class="form-text mb-0">Add your planned stops. At least one destination is required.</div>
                                        <button type="button" class="btn btn-outline-success btn-sm" id="add-search-destination">
                                            <i class="bi bi-plus-circle"></i> Add destination
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 align-items-end mt-0">
                                {% set popular_types = popular_vehicle_types or [] %}
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="vehicle_types">Vehicle type</label>
                                    <select class="form-select" id="vehicle_types" name="vehicle_types">
                                        <option value="" {% if not selected_vehicle_type %}selected{% endif %}>Any vehicle</option>
                                        {% for label in popular_types %}
                                            <option value="{{ label }}" {% if label == selected_vehicle_type %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                        {% for v in available_vehicle_types %}
                                            {% if v and v not in popular_types %}
                                                <option value="{{ v }}" {% if v == selected_vehicle_type %}selected{% endif %}>{{ v }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="fuel_type">Fuel type</label>
                                    <select class="form-select" id="fuel_type" name="fuel_type">
                                        <option value="" {% if not filters.fuel_type %}selected{% endif %}>Any fuel</option>
                                        {% for fuel in fuel_types %}
                                            <option value="{{ fuel }}" {% if fuel == filters.fuel_type %}selected{% endif %}>{{ fuel }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="seat_min">Seats min</label>
                                    <input type="number" class="form-control" id="seat_min" name="seat_min" value="{{ filters.seat_min if filters.seat_min is not none else '' }}" min="2" max="12">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="seat_max">Seats max</label>
                                    <input type="number" class="form-control" id="seat_max" name="seat_max" value="{{ filters.seat_max if filters.seat_max is not none else '' }}" min="2" max="12">
                                </div>
                            </div>
                            <div class="row g-3 align-items-end mt-0">
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="price_unit">Rate type (&#8377;/hr or &#8377;/day)</label>
                                    <select class="form-select" id="price_unit" name="price_unit">
                                        <option value="hour" {% if filters.price_unit == 'hour' %}selected{% endif %}>Per hour</option>
                                        <option value="day" {% if filters.price_unit == 'day' %}selected{% endif %}>Per day</option>
                                    </select>
                                </div>
                                <div class="col-lg-9 col-md-6 d-flex justify-content-md-end justify-content-lg-end">
                                    <button type="button" class="btn btn-outline-success flex-shrink-0 px-4" style="min-width: 9rem;" id="use-location">
                                        <i class="bi bi-geo-alt"></i> Use my current location
                                    </button>
                                </div>
                            </div>
                            <div class="row g-3 align-items-end mt-0">
                                <div class="col-lg-2 col-md-6">
                                    <label class="form-label" for="price_min">Min rate</label>
                                    <input type="number" class="form-control" name="price_min" id="price_min" value="{{ filters.price_min if filters.price_min is not none else '' }}" min="0" step="50">
                                </div>
                                <div class="col-lg-2 col-md-6">
                                    <label class="form-label" for="price_max">Max rate</label>
                                    <input type="number" class="form-control" name="price_max" id="price_max" value="{{ filters.price_max if filters.price_max is not none else '' }}" min="0" step="50">
                                </div>
                                <div class="col-lg-8 col-md-12">
                                    <div class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center justify-content-sm-end gap-2">
                                        <div class="form-check mb-0 d-flex align-items-center me-sm-3">
                                            <input class="form-check-input" type="checkbox" id="require_gps" name="require_gps" value="on" {% if filters.require_gps %}checked{% endif %}>
                                            <label class="form-check-label" for="require_gps">Only vehicles with GPS</label>
                                        </div>
                                        <button type="submit" class="btn btn-success flex-shrink-0 px-4" style="min-width: 9rem;">Update results</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="bg-light border rounded-4 px-3 py-2" id="selected-location">
                            {% if latitude is not none and longitude is not none %}
                                <span class="fw-semibold text-success">Pickup pinned</span>
                                <span class="text-muted small">{{ '%.5f'|format(latitude) }}, {{ '%.5f'|format(longitude) }}</span>
                            {% else %}
                                <span class="fw-semibold text-muted">No pickup chosen</span>
                                <span class="text-muted small">Tap the map or use your current location.</span>
                            {% endif %}
                        </div>
                    </div>
                </form>
                {% if error %}
                    <div class="alert alert-warning mt-3 mb-0" role="alert">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        {% if cars %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4 fw-semibold mb-0">Available near you</h2>
                <span class="text-muted small">Showing {{ cars|length }} vehicles within {{ radius or 10 }} km</span>
            </div>
            <div class="alert alert-success" role="alert">
                Promo codes you can try: {% for code, discount in promo_codes.items() %}<strong>{{ code }}</strong> ({{ (discount*100)|round|int }}% off){% if not loop.last %}, {% endif %}{% endfor %}
            </div>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for car in cars %}
                    {% set pricing_info = pricing.get(car.id) %}
                    <div class="col">
                        <div class="card car-card h-100" data-car-card="{{ car.id }}">
                            {% if car.images %}
                                {% set first_image = car.images[0] %}
                                {% if first_image and not first_image.lower().startswith('http') %}
                                    {% set image_url = url_for('serve_upload', filename=first_image) %}
                                {% else %}
                                    {% set image_url = first_image %}
                                {% endif %}
                                <img src="{{ image_url }}" class="card-img-top object-fit-cover car-gallery-trigger" data-gallery="{{ car.id }}" role="button" tabindex="0" alt="{{ car.name }}">
                            {% elif car.image_url %}
                                <img src="{{ car.image_url }}" class="card-img-top object-fit-cover car-gallery-trigger" data-gallery="{{ car.id }}" role="button" tabindex="0" alt="{{ car.name }}">
                            {% else %}
                                <div class="card-img-top vehicle-photo-placeholder d-flex align-items-center justify-content-center car-gallery-trigger" data-gallery="{{ car.id }}" role="button" tabindex="0">
                                    <i class="bi bi-camera"></i>
                                </div>
                            {% endif %}
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h3 class="h5 mb-1">{{ car.name }}</h3>
                                        <div class="text-muted small"><i class="bi bi-geo-alt"></i> {{ car.city or detected_city or 'Nearby' }} - {{ car.distance_km }} km away</div>
                                    </div>
                                    <span class="badge {{ 'bg-success' if car.status == 'Available' else 'bg-secondary' }}">{{ car.status }}</span>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mb-3 small text-muted">
                                    <span><i class="bi bi-fuel-pump"></i> {{ car.fuel_type or 'Fuel' }}</span>
                                    <span><i class="bi bi-gear-wide-connected"></i> {{ car.transmission or 'Transmission' }}</span>
                                    <span><i class="bi bi-people-fill"></i> {{ car.seats }} seats</span>
                                    {% if car.vehicle_type %}<span><i class="bi bi-car-front"></i> {{ car.vehicle_type }}</span>{% endif %}
                                    {% if car.has_gps %}<span><i class="bi bi-broadcast"></i> GPS ready</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ car.description or 'Flexible cancellation - Sanitised & ready - Unlimited km packages available' }}</p>
                                {% if pricing_info %}
                                    <div class="p-3 bg-light rounded-4 mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-semibold">&#8377; {{ pricing_info.total|round|int }} estimated</div>
                                                <div class="text-muted small">{{ pricing_info.hours }} hrs - Base &#8377; {{ pricing_info.base_amount|round }}{% if pricing_info.discount %} - Discount &#8377; {{ pricing_info.discount|round }}{% endif %}</div>
                                            </div>
                                            <div class="text-muted small">From &#8377; {{ (car.rate_per_hour * 4)|round|int }} / day approx</div>
                                        </div>
                                        <div class="mt-2 text-muted small">Suggested packs:
                                            {% for pack in pricing_info.packages %}
                                                <span class="badge bg-success-subtle text-success fw-semibold">{{ pack.label }} - &#8377; {{ pack.price|round|int }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="mt-auto">
                                    {% if car.status == 'Available' %}
                                        <form method="post"
                                              action="{{ url_for('rent_car', car_id=car.id) }}"
                                              class="row g-2"
                                              id="rent-form-{{ car.id }}"
                                              data-car-id="{{ car.id }}"
                                              data-car-lat="{{ car.latitude|default('') }}"
                                              data-car-lng="{{ car.longitude|default('') }}"
                                              data-base-total="{{ pricing_info.total if pricing_info else '' }}">
                                            <input type="hidden" name="start_time" value="{{ start_time or '' }}">
                                            <input type="hidden" name="end_time" value="{{ end_time or '' }}">
                                            <input type="hidden" name="price_unit" value="{{ filters.price_unit }}">
                                            <input type="hidden" name="delivery_type" value="pickup" data-role="delivery-type">
                                            <input type="hidden" name="delivery_latitude" value="" data-role="delivery-lat">
                                            <input type="hidden" name="delivery_longitude" value="" data-role="delivery-lng">
                                            <input type="hidden" name="delivery_address" value="" data-role="delivery-address">
                                            <input type="hidden" name="delivery_fee" value="0" data-role="delivery-fee-input">
                                            <input type="hidden" name="delivery_distance" value="" data-role="delivery-distance">
                                            {% for destination in destinations %}
                                                <input type="hidden" name="destinations" value="{{ destination }}">
                                            {% endfor %}
                                            <div class="col-12">
                                                <label class="form-label small text-muted d-block">How would you like to receive the vehicle?</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="fulfillment" id="pickup-{{ car.id }}" value="pickup" data-mode="pickup" required checked>
                                                    <label class="form-check-label" for="pickup-{{ car.id }}">I'll pick it up myself</label>
                                                </div>
                                                {% if car.delivery_options %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="fulfillment" id="delivery-{{ car.id }}" value="delivery" data-mode="delivery">
                                                    <label class="form-check-label" for="delivery-{{ car.id }}">Request delivery</label>
                                                </div>
                                                <div class="border rounded-4 p-3 mt-3 d-none" data-role="delivery-section">
                                                    <div class="small text-muted mb-2">Set your delivery point. We estimate the fee automatically from the host's rates.</div>
                                                    <div class="mb-2">
                                                        <label class="form-label small" for="delivery-address-{{ car.id }}">Delivery address (optional)</label>
                                                        <input type="text" class="form-control form-control-sm" id="delivery-address-{{ car.id }}" placeholder="Apartment, landmark, etc." data-role="delivery-address-input">
                                                    </div>
                                                    <div class="delivery-map mb-2" id="delivery-map-{{ car.id }}"></div>
                                                    <div class="d-flex gap-2 mb-2">
                                                        <button type="button" class="btn btn-outline-success btn-sm" data-role="locate-me"><i class="bi bi-geo"></i> Use my location</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-role="reset-delivery"><i class="bi bi-x-lg"></i> Clear</button>
                                                    </div>
                                                    <div class="small" data-role="delivery-summary">Select a delivery location to view charges.</div>
                                                </div>
                                                {% else %}
                                                <div class="small text-muted mt-1">Delivery is not available for this vehicle.</div>
                                                {% endif %}
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small text-muted" for="promo-{{ car.id }}">Promo code (optional)</label>
                                                <input type="text" class="form-control" id="promo-{{ car.id }}" name="promo_code" placeholder="e.g. ZOOM10">
                                            </div>
                                            <div class="col-12 d-grid">
                                                <button type="submit" class="btn btn-success">Book now</button>
                                            </div>
                                        </form>
                                    {% else %}
                                        <button class="btn btn-outline-secondary w-100" disabled>Currently unavailable</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif latitude is not none and longitude is not none and not error %}
            <div class="alert alert-info" role="alert">
                No vehicles matched the current search. Try increasing the radius or choosing a different location.
            </div>
        {% else %}
            <div class="alert alert-secondary" role="alert">
                Select a pickup spot on the map to see vehicles nearby.
            </div>
        {% endif %}
    </div>

    <div class="modal fade" id="carGalleryModal" tabindex="-1" aria-labelledby="carGalleryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="carGalleryModalLabel">Vehicle details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="carGalleryCarousel" class="carousel slide mb-3" data-bs-ride="false">
                        <div class="carousel-indicators"></div>
                        <div class="carousel-inner rounded-4 overflow-hidden"></div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carGalleryCarousel" data-bs-slide="prev" data-role="carousel-control" aria-label="Previous photo">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carGalleryCarousel" data-bs-slide="next" data-role="carousel-control" aria-label="Next photo">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="alert alert-secondary d-none" id="carGalleryEmpty">No photos uploaded for this vehicle yet.</div>
                    <div class="d-flex flex-column gap-3" data-role="gallery-details"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-role="focus-card">Go to booking options</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/destination_inputs.js') }}"></script>
    <script>
        const cityInput = document.getElementById('city-field');
        const suggestionPanel = document.getElementById('city-suggestions');
        const cityOptions = {{ city_entries|tojson|safe }};
        let clearLocation = () => {};
        if (cityInput && suggestionPanel) {
            const normalised = [];
            const seen = new Set();
            const buildLabel = (item) => item.state ? `${item.name}, ${item.state}` : item.name;
            cityOptions.forEach((entry) => {
                if (!entry || !entry.name) {
                    return;
                }
                const label = buildLabel(entry);
                if (seen.has(label.toLowerCase())) {
                    return;
                }
                seen.add(label.toLowerCase());
                normalised.push({ value: label, label });
            });
            normalised.sort((a, b) => a.label.localeCompare(b.label));
            let activeIndex = -1;
            let currentResults = [];

            const hideSuggestions = () => {
                suggestionPanel.classList.add('d-none');
                suggestionPanel.innerHTML = '';
                cityInput.setAttribute('aria-expanded', 'false');
                activeIndex = -1;
                currentResults = [];
            };

            const highlight = (index) => {
                const items = suggestionPanel.querySelectorAll('[data-value]');
                items.forEach((item, idx) => {
                    item.classList.toggle('active', idx === index);
                });
                activeIndex = index;
            };

            const applySelection = (value) => {
                cityInput.value = value;
                hideSuggestions();
                clearLocation();
                cityInput.dispatchEvent(new Event('change'));
            };

            const renderSuggestions = (term) => {
                const query = term.trim().toLowerCase();
                const results = query
                    ? normalised.filter((option) => option.label.toLowerCase().includes(query)).slice(0, 12)
                    : normalised.slice(0, 12);
                suggestionPanel.innerHTML = '';
                if (!results.length) {
                    suggestionPanel.innerHTML = '<div class="list-group-item text-muted small">No matching cities found</div>';
                    suggestionPanel.classList.remove('d-none');
                    cityInput.setAttribute('aria-expanded', 'true');
                    currentResults = [];
                    activeIndex = -1;
                    return;
                }
                const fragment = document.createDocumentFragment();
                results.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'list-group-item list-group-item-action text-start';
                    button.setAttribute('data-value', option.value);
                    button.setAttribute('role', 'option');
                    button.dataset.index = String(index);
                    button.textContent = option.label;
                    fragment.appendChild(button);
                });
                suggestionPanel.appendChild(fragment);
                suggestionPanel.classList.remove('d-none');
                cityInput.setAttribute('aria-expanded', 'true');
                currentResults = results;
                activeIndex = -1;
            };

            cityInput.addEventListener('focus', () => {
                renderSuggestions(cityInput.value);
            });
            cityInput.addEventListener('input', () => {
                clearLocation();
                renderSuggestions(cityInput.value);
            });
            cityInput.addEventListener('keydown', (event) => {
                if (suggestionPanel.classList.contains('d-none')) {
                    return;
                }
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (!currentResults.length) {
                        return;
                    }
                    const nextIndex = activeIndex + 1 >= currentResults.length ? 0 : activeIndex + 1;
                    highlight(nextIndex);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    if (!currentResults.length) {
                        return;
                    }
                    const prevIndex = activeIndex - 1 < 0 ? currentResults.length - 1 : activeIndex - 1;
                    highlight(prevIndex);
                } else if (event.key === 'Enter') {
                    if (activeIndex >= 0 && currentResults[activeIndex]) {
                        event.preventDefault();
                        applySelection(currentResults[activeIndex].value);
                    }
                } else if (event.key === 'Escape') {
                    hideSuggestions();
                }
            });
            cityInput.addEventListener('blur', () => {
                window.setTimeout(hideSuggestions, 120);
            });
            suggestionPanel.addEventListener('pointerdown', (event) => {
                const target = event.target.closest('[data-value]');
                if (!target) {
                    return;
                }
                event.preventDefault();
                applySelection(target.getAttribute('data-value') || '');
            });
        }
    </script>
    <script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
    <script>
        const mapElement = document.getElementById('map');
        const latitudeField = document.getElementById('latitude-field');
        const longitudeField = document.getElementById('longitude-field');
        const radiusInput = document.getElementById('radius');
        const useLocationBtn = document.getElementById('use-location');
        const selectedText = document.getElementById('selected-location');
        const searchForm = document.getElementById('search-form');
        const startField = document.getElementById('start-field');
        const endField = document.getElementById('end-field');
        const initialLat = {{ latitude if latitude is not none else 'null' }};
        const initialLng = {{ longitude if longitude is not none else 'null' }};
        const initialRadius = {{ radius or 10 }};
        const carsData = {{ cars_payload|tojson|safe }};
        const uploadBaseUrlRaw = "{{ url_for('serve_upload', filename='') }}";
        const uploadBaseUrl = uploadBaseUrlRaw.endsWith('/') ? uploadBaseUrlRaw : `${uploadBaseUrlRaw}/`;
        const pad = (value) => value.toString().padStart(2, '0');
        const formatDateTime = (date) => `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;

        const ESCAPE_LOOKUP = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        const escapeHtml = (value) => {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).replace(/[&<>"']/g, (char) => ESCAPE_LOOKUP[char] || char);
        };
        const resolveImageUrl = (path) => {
            if (!path) {
                return null;
            }
            if (/^https?:\/\//i.test(path)) {
                return path;
            }
            const cleaned = String(path).replace(/^\/+/, '');
            const encoded = cleaned.split('/').map((segment) => encodeURIComponent(segment)).join('/');
            return `${uploadBaseUrl}${encoded}`;
        };
        const formatRupees = (value) => {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return null;
            }
            return Math.round(numeric).toLocaleString('en-IN');
        };
        const formatDistance = (value) => {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return null;
            }
            return numeric >= 10 ? numeric.toFixed(1) : numeric.toFixed(2);
        };
        const buildFeatureBadge = (iconClass, label) => {
            if (!label) {
                return '';
            }
            const icon = iconClass ? `<i class="${iconClass}"></i>` : '';
            const text = `<span>${escapeHtml(label)}</span>`;
            return `<span class="badge bg-success-subtle text-success d-inline-flex align-items-center gap-1 px-2 py-1">${icon}${text}</span>`;
        };
        const cardRegistry = new Map();
        document.querySelectorAll('[data-car-card]').forEach((card) => {
            const identifier = card.getAttribute('data-car-card');
            if (identifier) {
                cardRegistry.set(identifier, card);
            }
        });
        const carLookup = new Map();
        if (Array.isArray(carsData)) {
            carsData.forEach((car) => {
                if (!car || car.id === undefined || car.id === null) {
                    return;
                }
                const carId = String(car.id);
                const normalizedImages = [];
                if (Array.isArray(car.images)) {
                    car.images.forEach((entry) => {
                        const resolved = resolveImageUrl(entry);
                        if (resolved) {
                            normalizedImages.push(resolved);
                        }
                    });
                }
                const fallbackImage = resolveImageUrl(car.image_url);
                if (!normalizedImages.length && fallbackImage) {
                    normalizedImages.push(fallbackImage);
                }
                carLookup.set(carId, { ...car, normalizedImages });
            });
        }
        const carGalleryModalEl = document.getElementById('carGalleryModal');
        const carGalleryModal = carGalleryModalEl && window.bootstrap ? new window.bootstrap.Modal(carGalleryModalEl) : null;
        const carGalleryTitle = carGalleryModalEl ? carGalleryModalEl.querySelector('.modal-title') : null;
        const carGalleryCarousel = carGalleryModalEl ? carGalleryModalEl.querySelector('#carGalleryCarousel') : null;
        const carGalleryIndicators = carGalleryCarousel ? carGalleryCarousel.querySelector('.carousel-indicators') : null;
        const carGalleryInner = carGalleryCarousel ? carGalleryCarousel.querySelector('.carousel-inner') : null;
        const carGalleryEmpty = document.getElementById('carGalleryEmpty');
        const carGalleryDetails = carGalleryModalEl ? carGalleryModalEl.querySelector('[data-role="gallery-details"]') : null;
        const focusCardButton = carGalleryModalEl ? carGalleryModalEl.querySelector('[data-role="focus-card"]') : null;
        if (focusCardButton) {
            focusCardButton.disabled = true;
        }
        const carouselControls = carGalleryModalEl ? Array.from(carGalleryModalEl.querySelectorAll('[data-role="carousel-control"]')) : [];
        const updateCarousel = (images, carName) => {
            if (!carGalleryCarousel || !carGalleryIndicators || !carGalleryInner) {
                return;
            }
            carGalleryIndicators.innerHTML = '';
            carGalleryInner.innerHTML = '';
            if (!images || !images.length) {
                carGalleryCarousel.classList.add('d-none');
                if (carGalleryEmpty) {
                    carGalleryEmpty.classList.remove('d-none');
                }
                carouselControls.forEach((control) => control.classList.add('d-none'));
                return;
            }
            carGalleryCarousel.classList.remove('d-none');
            if (carGalleryEmpty) {
                carGalleryEmpty.classList.add('d-none');
            }
            images.forEach((src, index) => {
                const indicator = document.createElement('button');
                indicator.type = 'button';
                indicator.setAttribute('data-bs-target', '#carGalleryCarousel');
                indicator.setAttribute('data-bs-slide-to', String(index));
                indicator.setAttribute('aria-label', `Slide ${index + 1}`);
                if (index === 0) {
                    indicator.classList.add('active');
                    indicator.setAttribute('aria-current', 'true');
                }
                carGalleryIndicators.appendChild(indicator);
                const item = document.createElement('div');
                item.className = `carousel-item${index === 0 ? ' active' : ''}`;
                const img = document.createElement('img');
                img.src = src;
                img.alt = carName ? `${carName} photo ${index + 1}` : `Vehicle photo ${index + 1}`;
                img.className = 'd-block w-100 modal-gallery-img rounded-4';
                item.appendChild(img);
                carGalleryInner.appendChild(item);
            });
            carouselControls.forEach((control) => control.classList.toggle('d-none', images.length <= 1));
        };
        const openCarModal = (rawId) => {
            if (!carGalleryModal || !rawId) {
                return;
            }
            const carId = String(rawId);
            const car = carLookup.get(carId);
            if (!car) {
                return;
            }
            const hourlyRate = Number(car.rate_per_hour);
            const approxDaily = Number.isFinite(hourlyRate) ? Math.round(hourlyRate * 4) : null;
            const distanceLabel = formatDistance(car.distance_km);
            const defaultDescription = 'Flexible cancellation - Sanitised & ready - Unlimited km packages available';
            if (carGalleryTitle) {
                carGalleryTitle.textContent = car.name || 'Vehicle details';
            }
            updateCarousel(car.normalizedImages, car.name || 'Vehicle');
            if (carGalleryDetails) {
                const metaChips = [];
                if (car.city) {
                    metaChips.push(buildFeatureBadge('bi bi-geo-alt', car.city));
                }
                if (distanceLabel) {
                    metaChips.push(buildFeatureBadge('bi bi-signpost-2', `${distanceLabel} km away`));
                }
                if (car.owner_public_name) {
                    metaChips.push(buildFeatureBadge('bi bi-person-badge', `Host ${car.owner_public_name}`));
                }
                if (Number.isFinite(Number(car.rating))) {
                    metaChips.push(buildFeatureBadge('bi bi-star-fill text-warning', `${Number(car.rating).toFixed(1)} rating`));
                }
                const featureBadges = [];
                if (Number.isFinite(Number(car.seats))) {
                    featureBadges.push(buildFeatureBadge('bi bi-people-fill', `${car.seats} seats`));
                }
                if (car.vehicle_type) {
                    featureBadges.push(buildFeatureBadge('bi bi-car-front', car.vehicle_type));
                }
                if (car.fuel_type) {
                    featureBadges.push(buildFeatureBadge('bi bi-fuel-pump', car.fuel_type));
                }
                if (car.transmission) {
                    featureBadges.push(buildFeatureBadge('bi bi-gear-wide-connected', car.transmission));
                }
                if (car.has_gps) {
                    featureBadges.push(buildFeatureBadge('bi bi-broadcast', 'GPS ready'));
                }
                const statusBadge = car.status ? `<span class="badge ${car.status === 'Available' ? 'bg-success' : 'bg-secondary'}">${escapeHtml(car.status)}</span>` : '';
                const priceBlock = Number.isFinite(hourlyRate) || approxDaily !== null
                    ? `<div class="bg-light rounded-4 p-3">
                            <div class="d-flex align-items-start flex-wrap gap-2">
                                <div>
                                    ${Number.isFinite(hourlyRate) ? `<div class="fw-semibold mb-1">&#8377; ${formatRupees(hourlyRate)} / hr</div>` : ''}
                                    ${approxDaily !== null ? `<div class="text-muted small">&#8377; ${formatRupees(approxDaily)} / day approx</div>` : ''}
                                </div>
                            </div>
                        </div>` : '';
                carGalleryDetails.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div class="d-flex flex-wrap gap-2 small text-muted">
                            ${metaChips.join('')}
                        </div>
                        ${statusBadge}
                    </div>
                    ${featureBadges.length ? `<div class="d-flex flex-wrap gap-2 mt-2">${featureBadges.join('')}</div>` : ''}
                    ${priceBlock}
                    <p class="text-muted small mb-0 mt-2">${escapeHtml(car.description || defaultDescription)}</p>
                `;
            }
            if (focusCardButton) {
                if (cardRegistry.has(carId)) {
                    focusCardButton.classList.remove('d-none');
                    focusCardButton.disabled = false;
                    focusCardButton.setAttribute('data-target-card', carId);
                } else {
                    focusCardButton.classList.add('d-none');
                    focusCardButton.disabled = true;
                    focusCardButton.removeAttribute('data-target-card');
                }
            }
            carGalleryModal.show();
        };
        const registerGalleryTriggers = () => {
            document.querySelectorAll('.car-gallery-trigger').forEach((trigger) => {
                const carId = trigger.getAttribute('data-gallery');
                if (!carId || trigger.dataset.galleryBound === '1') {
                    return;
                }
                const handleOpen = (event) => {
                    event.preventDefault();
                    openCarModal(carId);
                };
                trigger.addEventListener('click', handleOpen);
                trigger.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        handleOpen(event);
                    }
                });
                trigger.dataset.galleryBound = '1';
            });
        };
        registerGalleryTriggers();
        if (focusCardButton) {
            focusCardButton.addEventListener('click', () => {
                if (focusCardButton.disabled) {
                    return;
                }
                const targetId = focusCardButton.getAttribute('data-target-card');
                if (!targetId) {
                    return;
                }
                const targetCard = cardRegistry.get(targetId);
                if (!targetCard) {
                    return;
                }
                if (carGalleryModal) {
                    carGalleryModal.hide();
                }
                setTimeout(() => {
                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetCard.classList.add('ring-highlight');
                    setTimeout(() => targetCard.classList.remove('ring-highlight'), 1500);
                }, 250);
            });
        }

        if (cityInput) {
            clearLocation = () => {
                latitudeField.value = '';
                longitudeField.value = '';
            };
            cityInput.addEventListener('change', clearLocation);
        }

        const DEFAULT_VIEW = { lat: 20.5937, lng: 78.9629, zoom: 5 };
        const map = L.map(mapElement, { zoomControl: true });
        const carIcon = L.divIcon({
            className: 'map-car-icon',
            html: '<span class="map-car-icon-pin"></span>',
            iconSize: [44, 52],
            iconAnchor: [22, 46],
            popupAnchor: [0, -40],
        });
        const pickupIcon = L.divIcon({
            className: 'map-pickup-icon',
            html: '<span class="map-pickup-icon-pin"></span>',
            iconSize: [44, 52],
            iconAnchor: [22, 46],
            popupAnchor: [0, -40],
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        let locationMarker = null;
        let radiusCircle = null;
        const carLayer = L.layerGroup().addTo(map);

        const ensureMapSize = () => {
            map.invalidateSize();
        };

        map.whenReady(() => {
            ensureMapSize();
            setTimeout(ensureMapSize, 150);
        });

        if ('ResizeObserver' in window) {
            const resizeObserver = new ResizeObserver(() => ensureMapSize());
            resizeObserver.observe(mapElement);
        } else {
            window.addEventListener('resize', ensureMapSize);
        }

        window.addEventListener('load', () => setTimeout(ensureMapSize, 200));
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(ensureMapSize, 100);
            }
        });

        function focusOn(lat, lng, zoom = 13) {
            map.setView([lat, lng], zoom);
            ensureMapSize();
        }

        function updateSelectedLocation(lat, lng) {
            latitudeField.value = lat;
            longitudeField.value = lng;
            selectedText.innerHTML = `
                <span class="fw-semibold text-success">Pickup pinned</span>
                <span class="text-muted small d-block">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>`;
            if (!locationMarker) {
                locationMarker = L.marker([lat, lng], { draggable: true, icon: pickupIcon, zIndexOffset: 900 }).addTo(map);
                locationMarker.on('dragend', (event) => {
                    const pos = event.target.getLatLng();
                    updateSelectedLocation(pos.lat, pos.lng);
                    redrawRadius();
                });
            } else {
                locationMarker.setLatLng([lat, lng]);
                locationMarker.setIcon(pickupIcon);
            }
            redrawRadius();
            ensureMapSize();
        }

        function radiusToZoom(km) {
            if (!Number.isFinite(km) || km <= 0) {
                return 13;
            }
            if (km <= 3) return 14;
            if (km <= 8) return 13;
            if (km <= 15) return 12;
            if (km <= 30) return 11;
            if (km <= 60) return 10;
            if (km <= 120) return 9;
            if (km <= 240) return 8;
            if (km <= 480) return 7;
            if (km <= 960) return 6;
            return 5;
        }

        function fitToRadius(padding = 0.2) {
            if (radiusCircle) {
                const bounds = radiusCircle.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(padding));
                    return;
                }
            }
            if (locationMarker) {
                const radiusValue = radiusInput ? parseFloat(radiusInput.value) : initialRadius;
                const zoom = radiusToZoom(Number.isFinite(radiusValue) ? radiusValue : initialRadius);
                map.setView(locationMarker.getLatLng(), zoom);
            }
        }

        function redrawRadius({ adjustView = false } = {}) {
            if (!radiusInput) {
                return;
            }
            const lat = parseFloat(latitudeField.value);
            const lng = parseFloat(longitudeField.value);
            const rawKm = parseFloat(radiusInput.value);
            const km = Number.isFinite(rawKm) && rawKm > 0 ? rawKm : initialRadius;
            if (!Number.isFinite(rawKm) || rawKm <= 0) {
                radiusInput.value = km.toString();
            }
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                if (radiusCircle) {
                    radiusCircle.remove();
                    radiusCircle = null;
                }
                return;
            }
            const radiusMeters = km * 1000;
            if (!radiusCircle) {
                radiusCircle = L.circle([lat, lng], {
                    radius: radiusMeters,
                    color: '#0d9f5c',
                    weight: 2,
                    fillColor: '#34d399',
                    fillOpacity: 0.15,
                }).addTo(map);
            } else {
                radiusCircle.setLatLng([lat, lng]);
                radiusCircle.setRadius(radiusMeters);
            }
            if (adjustView) {
                map.setView([lat, lng], radiusToZoom(km));
            }
        }

        map.on('click', (event) => {
            updateSelectedLocation(event.latlng.lat, event.latlng.lng);
            redrawRadius({ adjustView: true });
            fitToRadius();
        });

        if (radiusInput) {
            const handleRadiusInput = () => redrawRadius({ adjustView: true });
            radiusInput.addEventListener('change', handleRadiusInput);
            radiusInput.addEventListener('input', handleRadiusInput);
        }

        if (Number.isFinite(initialLat) && Number.isFinite(initialLng)) {
            updateSelectedLocation(initialLat, initialLng);
            redrawRadius({ adjustView: true });
            if (!carsData || !carsData.length) {
                fitToRadius();
            }
        } else {
            focusOn(DEFAULT_VIEW.lat, DEFAULT_VIEW.lng, DEFAULT_VIEW.zoom);
        }

        if (Array.isArray(carsData) && carsData.length) {
            const markerPositions = [];
            carsData.forEach((car) => {
                if (!car) {
                    return;
                }
                const lat = Number(car.latitude);
                const lng = Number(car.longitude);
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                    return;
                }
                markerPositions.push([lat, lng]);
                const carId = String(car.id);
                const distanceLabel = formatDistance(car.distance_km);
                const seatsLabel = Number.isFinite(Number(car.seats)) ? `${car.seats} seats` : null;
                const priceLabel = formatRupees(car.rate_per_hour);
                const popupLines = [
                    `<strong>${escapeHtml(car.name || 'Vehicle')}</strong>`,
                    [distanceLabel ? `${distanceLabel} km away` : null, seatsLabel].filter(Boolean).join('  '),
                    priceLabel ? `&#8377; ${priceLabel} / hr` : ''
                ].filter((line) => line && line.trim().length);
                const popupContent = `
                    <div class="small text-start">
                        ${popupLines.map((line) => `<div>${line}</div>`).join('')}
                        <div class="mt-2 d-grid">
                            <button type="button" class="btn btn-sm btn-success car-popup-view" data-gallery="${escapeHtml(carId)}">
                                View details &amp; photos
                            </button>
                        </div>
                    </div>
                `;
                const marker = L.marker([lat, lng], { icon: carIcon, riseOnHover: true, title: car.name || 'Available vehicle' });
                marker.bindPopup(popupContent);
                marker.on('popupopen', (event) => {
                    const popupEl = event.popup.getElement();
                    if (!popupEl) {
                        return;
                    }
                    popupEl.querySelectorAll('.car-popup-view').forEach((button) => {
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            marker.closePopup();
                            openCarModal(carId);
                        });
                    });
                });
                marker.addTo(carLayer);
            });
            if (markerPositions.length) {
                const bounds = L.latLngBounds(markerPositions);
                if (locationMarker) {
                    bounds.extend(locationMarker.getLatLng());
                }
                if (radiusCircle) {
                    bounds.extend(radiusCircle.getBounds());
                }
                map.fitBounds(bounds.pad(0.2));
                ensureMapSize();
            }
        }

        if (useLocationBtn && navigator.geolocation) {
            useLocationBtn.addEventListener('click', () => {
                useLocationBtn.disabled = true;
                useLocationBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Locating...';
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    focusOn(latitude, longitude);
                    updateSelectedLocation(latitude, longitude);
                    useLocationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Location set';
                    useLocationBtn.classList.remove('btn-outline-success');
                    useLocationBtn.classList.add('btn-success');
                    useLocationBtn.disabled = false;
                }, () => {
                    alert('Unable to fetch location. Please allow access or click on the map.');
                    useLocationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Use my current location';
                    useLocationBtn.disabled = false;
                });
            });
        } else if (useLocationBtn) {
            useLocationBtn.style.display = 'none';
        }

        const syncEndConstraints = () => {
            if (!startField || !endField || !startField.value) {
                return;
            }
            endField.min = startField.value;
            if (!endField.value || endField.value <= startField.value) {
                const startDate = new Date(startField.value);
                const adjusted = new Date(startDate.getTime() + 60 * 60 * 1000);
                endField.value = formatDateTime(adjusted);
            }
        };

        if (startField) {
            startField.addEventListener('change', () => {
                syncEndConstraints();
            });
        }
        if (endField) {
            endField.addEventListener('change', () => {
                syncEndConstraints();
            });
        }

        searchForm.addEventListener('submit', (event) => {
            if (startField && endField && startField.value && endField.value && endField.value <= startField.value) {
                event.preventDefault();
                alert('Trip end time must be after the start time.');
                endField.focus();
                return;
            }
            const hasCoordinates = Boolean(latitudeField.value && longitudeField.value);
            const cityValue = cityInput ? cityInput.value.trim() : '';
            if (!hasCoordinates && !cityValue) {
                event.preventDefault();
                alert('Please select a pickup location on the map or enter a city before searching.');
            }
        });

        if (startField && !startField.value) {
            const now = new Date();
            now.setMinutes(0, 0, 0);
            const start = new Date(now.getTime() + 60 * 60 * 1000);
            const end = new Date(start.getTime() + 4 * 60 * 60 * 1000);
            startField.value = formatDateTime(start);
            if (endField && !endField.value) {
                endField.value = formatDateTime(end);
            }
        }
        syncEndConstraints();

        const toRadians = (value) => (Number(value) * Math.PI) / 180;
        const haversineKm = (lat1, lng1, lat2, lng2) => {
            if (![lat1, lng1, lat2, lng2].every(Number.isFinite)) {
                return NaN;
            }
            const dLat = toRadians(lat2 - lat1);
            const dLng = toRadians(lng2 - lng1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return 6371 * c;
        };
        const destinationsContainer = searchForm ? searchForm.querySelector('[data-destination-container]') : null;
        const collectCurrentDestinations = () => {
            if (!destinationsContainer) {
                return [];
            }
            return Array.from(destinationsContainer.querySelectorAll('input[name="destinations"]'))
                .map((input) => input.value.trim())
                .filter((value, index, array) => value && array.indexOf(value) === index);
        };
        const presetDestinations = {{ destinations|tojson|safe }};
        if (destinationsContainer && Array.isArray(presetDestinations) && presetDestinations.length) {
            const inputs = Array.from(destinationsContainer.querySelectorAll('input[name="destinations"]'));
            presetDestinations.forEach((value, index) => {
                if (!value) {
                    return;
                }
                const currentInput = inputs[index];
                if (currentInput && !currentInput.value) {
                    currentInput.value = value;
                }
            });
        }
        const syncDestinationsIntoForm = (form) => {
            if (!form) {
                return;
            }
            form.querySelectorAll('input[name="destinations"]').forEach((input) => input.remove());
            collectCurrentDestinations().forEach((destination) => {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'destinations';
                hidden.value = destination;
                hidden.dataset.role = 'dynamic-destination';
                form.appendChild(hidden);
            });
        };

        const registerRentForms = () => {
            document.querySelectorAll('form[id^="rent-form-"]').forEach((form) => {
                if (!form || form.dataset.enhanced === '1') {
                    return;
                }
                const carId = form.getAttribute('data-car-id');
                const baseRaw = form.getAttribute('data-base-total');
                const parsedBase = baseRaw && baseRaw.trim() !== '' ? Number(baseRaw) : NaN;
                const baseTotal = Number.isFinite(parsedBase) ? parsedBase : null;
                const carData = carLookup.get(String(carId));
                const hostLat = carData && carData.latitude !== undefined
                    ? Number(carData.latitude)
                    : Number(form.getAttribute('data-car-lat'));
                const hostLng = carData && carData.longitude !== undefined
                    ? Number(carData.longitude)
                    : Number(form.getAttribute('data-car-lng'));
                const hasHostLocation = Number.isFinite(hostLat) && Number.isFinite(hostLng);
                const deliveryOptions = (carData && carData.delivery_options) ? carData.delivery_options : {};
                const deliveryEntries = Object.entries(deliveryOptions)
                    .map(([distance, price]) => ({
                        distance: Number(distance),
                        price: Number(price),
                    }))
                    .filter((entry) => Number.isFinite(entry.distance) && Number.isFinite(entry.price) && entry.distance > 0)
                    .sort((a, b) => a.distance - b.distance);

                const hiddenType = form.querySelector('[data-role="delivery-type"]');
                const hiddenLat = form.querySelector('[data-role="delivery-lat"]');
                const hiddenLng = form.querySelector('[data-role="delivery-lng"]');
                const hiddenAddress = form.querySelector('[data-role="delivery-address"]');
                const hiddenFee = form.querySelector('[data-role="delivery-fee-input"]');
                const hiddenDistance = form.querySelector('[data-role="delivery-distance"]');
                const addressInput = form.querySelector('[data-role="delivery-address-input"]');
                const summaryEl = form.querySelector('[data-role="delivery-summary"]');
                const deliverySection = form.querySelector('[data-role="delivery-section"]');
                const locateBtn = form.querySelector('[data-role="locate-me"]');
                const resetBtn = form.querySelector('[data-role="reset-delivery"]');
                const mapContainer = form.querySelector('[id^="delivery-map-"]');
                const modeInputs = form.querySelectorAll('input[name="fulfillment"][data-mode]');
                const defaultSummary = summaryEl ? summaryEl.textContent : '';
                const pickupSummary = baseTotal !== null
                    ? `Pickup selected. Estimated trip total Rs ${formatRupees(baseTotal)}.`
                    : 'Pickup selected. Trip total will be confirmed once the schedule is set.';

                const state = {
                    mode: 'pickup',
                    deliveryValid: false,
                    fee: 0,
                    distanceKm: 0,
                };

                let deliveryMap = null;
                let deliveryMarker = null;
                let hostMarker = null;
                const ensureMap = () => {
                    if (!deliverySection || !mapContainer) {
                        return;
                    }
                    if (deliveryMap) {
                        return;
                    }
                    deliveryMap = L.map(mapContainer, { attributionControl: false, zoomControl: false });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 18,
                        attribution: '&copy; OpenStreetMap contributors',
                    }).addTo(deliveryMap);
                    if (hasHostLocation) {
                        hostMarker = L.circleMarker([hostLat, hostLng], {
                            radius: 6,
                            color: '#16a34a',
                            fillColor: '#bbf7d0',
                            fillOpacity: 0.9,
                        }).addTo(deliveryMap);
                        hostMarker.bindTooltip('Host vehicle location', { permanent: false });
                        deliveryMap.setView([hostLat, hostLng], 12);
                    } else {
                        deliveryMap.setView([20.5937, 78.9629], 5);
                    }
                    deliveryMap.on('click', (event) => {
                        const { lat, lng } = event.latlng;
                        setDeliveryLocation(lat, lng);
                    });
                    setTimeout(() => {
                        if (deliveryMap) {
                            deliveryMap.invalidateSize();
                        }
                    }, 100);
                };

                const updateSummary = () => {
                    if (!summaryEl) {
                        return;
                    }
                    if (state.mode !== 'delivery') {
                        summaryEl.textContent = pickupSummary;
                        return;
                    }
                    if (!deliveryEntries.length) {
                        summaryEl.textContent = 'This host has not shared delivery charges. Please coordinate directly before requesting delivery.';
                        return;
                    }
                    if (!state.deliveryValid) {
                        summaryEl.textContent = 'Select a delivery location within the host delivery range to view charges.';
                        return;
                    }
                    const feeDisplay = formatRupees(state.fee);
                    const feeLabel = feeDisplay !== null && feeDisplay !== undefined
                        ? feeDisplay
                        : state.fee.toFixed(0);
                    const distanceLabel = state.distanceKm >= 1
                        ? `${state.distanceKm.toFixed(1)} km`
                        : `${state.distanceKm.toFixed(2)} km`;
                    if (baseTotal !== null) {
                        const combined = baseTotal + state.fee;
                        const combinedDisplay = formatRupees(combined) ?? combined.toFixed(0);
                        const baseDisplay = formatRupees(baseTotal) ?? baseTotal.toFixed(0);
                        summaryEl.textContent = `Delivery fee Rs ${feeLabel} (~${distanceLabel}). Estimated trip total Rs ${combinedDisplay} (rental Rs ${baseDisplay} + delivery Rs ${feeLabel}).`;
                    } else {
                        summaryEl.textContent = `Delivery fee Rs ${feeLabel} (~${distanceLabel}). Final billing will be confirmed once trip timings are set.`;
                    }
                };

                const clearDelivery = () => {
                    if (deliveryMarker) {
                        deliveryMarker.remove();
                        deliveryMarker = null;
                    }
                    hiddenLat.value = '';
                    hiddenLng.value = '';
                    hiddenFee.value = '0';
                    hiddenDistance.value = '';
                    state.deliveryValid = false;
                    state.fee = 0;
                    state.distanceKm = 0;
                    updateSummary();
                };

                const setDeliveryLocation = (lat, lng) => {
                    const numericLat = Number(lat);
                    const numericLng = Number(lng);
                    if (!Number.isFinite(numericLat) || !Number.isFinite(numericLng)) {
                        return;
                    }
                    ensureMap();
                    if (!deliveryMap) {
                        return;
                    }
                    const latLng = [numericLat, numericLng];
                    if (deliveryMarker) {
                        deliveryMarker.setLatLng(latLng);
                    } else {
                        deliveryMarker = L.marker(latLng, { draggable: true }).addTo(deliveryMap);
                        deliveryMarker.on('dragend', (event) => {
                            const pos = event.target.getLatLng();
                            setDeliveryLocation(pos.lat, pos.lng);
                        });
                    }
                    deliveryMap.panTo(latLng);
                    hiddenLat.value = numericLat.toFixed(6);
                    hiddenLng.value = numericLng.toFixed(6);

                    state.deliveryValid = false;
                    state.fee = 0;
                    state.distanceKm = 0;

                    if (hasHostLocation) {
                        const distanceKm = haversineKm(hostLat, hostLng, numericLat, numericLng);
                        if (Number.isFinite(distanceKm)) {
                            state.distanceKm = distanceKm;
                            let applicable = null;
                            for (const option of deliveryEntries) {
                                if (distanceKm <= option.distance + 0.01) {
                                    applicable = option;
                                    break;
                                }
                            }
                            if (applicable) {
                                state.deliveryValid = true;
                                state.fee = Math.max(0, applicable.price);
                            }
                        }
                    } else {
                        state.deliveryValid = deliveryEntries.length === 0;
                        state.fee = 0;
                        state.distanceKm = 0;
                    }

                    if (state.deliveryValid) {
                        hiddenFee.value = state.fee.toFixed(2);
                        hiddenDistance.value = state.distanceKm.toFixed(2);
                    } else {
                        hiddenFee.value = '';
                        hiddenDistance.value = state.distanceKm > 0 ? state.distanceKm.toFixed(2) : '';
                    }
                    updateSummary();
                };

                const handleModeChange = (event) => {
                    const mode = event.target.dataset.mode === 'delivery' ? 'delivery' : 'pickup';
                    state.mode = mode;
                    if (hiddenType) {
                        hiddenType.value = mode;
                    }
                    if (mode === 'delivery') {
                        if (deliverySection) {
                            deliverySection.classList.remove('d-none');
                        }
                        ensureMap();
                        setTimeout(() => {
                            if (deliveryMap) {
                                deliveryMap.invalidateSize();
                            }
                        }, 120);
                        updateSummary();
                    } else {
                        if (deliverySection) {
                            deliverySection.classList.add('d-none');
                        }
                        clearDelivery();
                    }
                };

                modeInputs.forEach((input) => {
                    input.addEventListener('change', handleModeChange);
                });

                if (addressInput && hiddenAddress) {
                    addressInput.addEventListener('input', () => {
                        hiddenAddress.value = addressInput.value.trim();
                    });
                }

                if (locateBtn) {
                    if ('geolocation' in navigator) {
                        locateBtn.addEventListener('click', () => {
                            locateBtn.disabled = true;
                            const originalLabel = locateBtn.innerHTML;
                            locateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Locating...';
                            navigator.geolocation.getCurrentPosition((position) => {
                                const { latitude, longitude } = position.coords;
                                setDeliveryLocation(latitude, longitude);
                                locateBtn.innerHTML = '<i class="bi bi-geo"></i> Location set';
                                locateBtn.classList.remove('btn-outline-success');
                                locateBtn.classList.add('btn-success');
                                locateBtn.disabled = false;
                            }, () => {
                                alert('Unable to detect your current location. Please allow access or drop a pin on the map.');
                                locateBtn.innerHTML = originalLabel;
                                locateBtn.disabled = false;
                            });
                        });
                    } else {
                        locateBtn.style.display = 'none';
                    }
                }

                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (addressInput) {
                            addressInput.value = '';
                        }
                        if (hiddenAddress) {
                            hiddenAddress.value = '';
                        }
                        clearDelivery();
                        if (deliverySection) {
                            deliverySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }

                form.addEventListener('submit', (event) => {
                    if (hiddenAddress && addressInput) {
                        hiddenAddress.value = addressInput.value.trim();
                    }
                    syncDestinationsIntoForm(form);
                    if (state.mode === 'delivery') {
                        if (!deliveryEntries.length) {
                            event.preventDefault();
                            alert('Delivery is not available for this vehicle.');
                            return;
                        }
                        if (!state.deliveryValid) {
                            event.preventDefault();
                            alert('Please choose a delivery location within the host delivery range before booking.');
                            return;
                        }
                        if (!hiddenLat.value || !hiddenLng.value) {
                            event.preventDefault();
                            alert('Drop a delivery pin on the map or share your location before booking.');
                            return;
                        }
                    } else {
                        hiddenFee.value = '0';
                        hiddenDistance.value = '';
                        hiddenLat.value = '';
                        hiddenLng.value = '';
                    }
                });

                state.mode = 'pickup';
                if (hiddenType) {
                    hiddenType.value = 'pickup';
                }
                if (summaryEl) {
                    summaryEl.textContent = pickupSummary || defaultSummary;
                }
                form.dataset.enhanced = '1';
            });
        };
        registerRentForms();
    </script>
{% endblock %}



