{% extends "base.html" %}
{% block title %}Find Vehicles | DriveNow{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
    <style>
        #map {
            height: 420px;
            min-height: 420px;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 25px 45px rgba(15, 118, 110, 0.12);
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.6), rgba(209, 250, 229, 0.3));
            position: relative;
        }
        .leaflet-container {
            font-family: "Inter", sans-serif;
        }
        .leaflet-container img.leaflet-image-layer,
        .leaflet-container img.leaflet-tile {
            max-width: none !important;
            max-height: none !important;
        }
        .car-card {
            border: none;
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(15, 118, 110, 0.08);
        }
        .car-card img {
            height: 190px;
            object-fit: cover;
        }
        .rating {
            color: #facc15;
        }
        .filter-bar {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(15,118,110,0.08);
            padding: 1.5rem;
        }
        .vehicle-type-field {
            position: relative;
            position: relative;
        }
        .vehicle-type-field .vehicle-type-select {
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 0.5rem 2.25rem 0.5rem 0.85rem;
            font-size: 1rem;
            font-weight: 400;
            color: #0f172a;
            height: auto;
            box-shadow: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .vehicle-type-field .vehicle-type-select:focus {
            border-color: #0d9f5c;
            box-shadow: 0 0 0 0.25rem rgba(13, 159, 92, 0.15);
        }
    </style>
{% endblock %}
{% block content %}
<section class="py-4">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1">Select your pickup point</h1>
                <p class="text-muted mb-0">Drag the pin or tap the map. Refine filters to see vehicles that suit your drive.</p>
            </div>
            <div class="bg-white shadow-sm rounded-4 px-4 py-3">
                <div class="small text-uppercase text-muted fw-semibold">Trip summary</div>
                <div class="fw-semibold">City: {{ city_display or detected_city or '-' }}</div>
                <div class="text-muted">Start: {{ start_time or '-' }}</div>
                <div class="text-muted">End: {{ end_time or '-' }}</div>
            </div>
        </div>

        {% if detected_city %}
            <div class="alert alert-success" role="alert">
                We detected <strong>{{ detected_city }}</strong> based on your map selection. Adjust if you prefer another city.
            </div>
        {% endif %}

        {% if profile_warning %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ profile_warning }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="card card-zoom mb-5">
            <div class="card-body">
                <form method="post" id="search-form" class="row g-3 align-items-end">
                    <input type="hidden" name="latitude" id="latitude-field" value="{{ latitude if latitude is not none else '' }}">
                    <input type="hidden" name="longitude" id="longitude-field" value="{{ longitude if longitude is not none else '' }}">
                    {% set selected_vehicle_type = filters.vehicle_types|first if filters.vehicle_types else '' %}
                    <div class="col-12">
                        <div id="map"></div>
                    </div>
                    <div class="col-12">
                        <div class="filter-bar">
                            <div class="row g-3 align-items-end">
                                <div class="col-lg-3 col-md-4">
                                    <label class="form-label" for="city-field">City</label>
                                    <input type="text" class="form-control" name="city" id="city-field" value="{{ city or detected_city or '' }}" placeholder="e.g. Bengaluru" list="city-options">
                                    {% if city_entries %}
                                        <datalist id="city-options">
                                            {% for entry in city_entries %}
                                                {% set label = entry.name ~ (', ' ~ entry.state if entry.state) %}
                                                <option value="{{ label }}">
                                            {% endfor %}
                                        </datalist>
                                    {% endif %}
                                </div>
                                <div class="col-lg-3 col-md-4">
                                    <label class="form-label" for="start-field">Trip start</label>
                                    <input type="datetime-local" class="form-control" name="start_time" id="start-field" value="{{ start_time or '' }}" required>
                                </div>
                                <div class="col-lg-3 col-md-4">
                                    <label class="form-label" for="end-field">Trip end</label>
                                    <input type="datetime-local" class="form-control" name="end_time" id="end-field" value="{{ end_time or '' }}" required>
                                </div>
                            </div>
                            <div class="row g-3 align-items-end mt-0">
                                {% set popular_types = popular_vehicle_types or [] %}
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="vehicle_types">Vehicle type</label>
                                    <select class="form-select" id="vehicle_types" name="vehicle_types">
                                        <option value="" {% if not selected_vehicle_type %}selected{% endif %}>Any vehicle</option>
                                        {% for label in popular_types %}
                                            <option value="{{ label }}" {% if label == selected_vehicle_type %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                        {% for v in available_vehicle_types %}
                                            {% if v and v not in popular_types %}
                                                <option value="{{ v }}" {% if v == selected_vehicle_type %}selected{% endif %}>{{ v }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="fuel_type">Fuel type</label>
                                    <select class="form-select" id="fuel_type" name="fuel_type">
                                        <option value="" {% if not filters.fuel_type %}selected{% endif %}>Any fuel</option>
                                        {% for fuel in fuel_types %}
                                            <option value="{{ fuel }}" {% if fuel == filters.fuel_type %}selected{% endif %}>{{ fuel }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="seat_min">Seats min</label>
                                    <input type="number" class="form-control" id="seat_min" name="seat_min" value="{{ filters.seat_min if filters.seat_min is not none else '' }}" min="2" max="12">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label" for="seat_max">Seats max</label>
                                    <input type="number" class="form-control" id="seat_max" name="seat_max" value="{{ filters.seat_max if filters.seat_max is not none else '' }}" min="2" max="12">
                                </div>
                            </div>
                            <div class="row g-3 align-items-end mt-0">
                                <div class="col-lg-2 col-md-4">
                                    <label class="form-label" for="radius">Radius (km)</label>
                                    <input type="number" class="form-control" name="radius" id="radius" min="1" max="200" step="1" value="{{ radius or 10 }}">
                                </div>
                                <div class="col-lg-2 col-md-4">
                                    <label class="form-label" for="price_unit">Rate type (&#8377;/hr or &#8377;/day)</label>
                                    <select class="form-select" id="price_unit" name="price_unit">
                                        <option value="hour" {% if filters.price_unit == 'hour' %}selected{% endif %}>Per hour</option>
                                        <option value="day" {% if filters.price_unit == 'day' %}selected{% endif %}>Per day</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4">
                                    <label class="form-label" for="price_min">Min rate</label>
                                    <input type="number" class="form-control" name="price_min" id="price_min" value="{{ filters.price_min if filters.price_min is not none else '' }}" min="0" step="50">
                                </div>
                                <div class="col-lg-2 col-md-4">
                                    <label class="form-label" for="price_max">Max rate</label>
                                    <input type="number" class="form-control" name="price_max" id="price_max" value="{{ filters.price_max if filters.price_max is not none else '' }}" min="0" step="50">
                                </div>
                                <div class="col-lg-4 col-md-8">
                                    <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-lg-end gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="require_gps" name="require_gps" value="on" {% if filters.require_gps %}checked{% endif %}>
                                            <label class="form-check-label" for="require_gps">Only vehicles with GPS</label>
                                        </div>
                                        <div class="d-flex flex-column gap-2">
                                            <button type="button" class="btn btn-outline-success" id="use-location"><i class="bi bi-geo-alt"></i> Use my current location</button>
                                            <button type="submit" class="btn btn-success btn-lg">Update results</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="bg-light border rounded-4 px-3 py-2" id="selected-location">
                            {% if latitude is not none and longitude is not none %}
                                <span class="fw-semibold text-success">Pickup pinned</span>
                                <span class="text-muted small">{{ '%.5f'|format(latitude) }}, {{ '%.5f'|format(longitude) }}</span>
                            {% else %}
                                <span class="fw-semibold text-muted">No pickup chosen</span>
                                <span class="text-muted small">Tap the map or use your current location.</span>
                            {% endif %}
                        </div>
                    </div>
                </form>
                {% if error %}
                    <div class="alert alert-warning mt-3 mb-0" role="alert">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        {% if cars %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4 fw-semibold mb-0">Available near you</h2>
                <span class="text-muted small">Showing {{ cars|length }} vehicles within {{ radius or 10 }} km</span>
            </div>
            <div class="alert alert-success" role="alert">
                Promo codes you can try: {% for code, discount in promo_codes.items() %}<strong>{{ code }}</strong> ({{ (discount*100)|round|int }}% off){% if not loop.last %}, {% endif %}{% endfor %}
            </div>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for car in cars %}
                    {% set pricing_info = pricing.get(car.id) %}
                    <div class="col">
                        <div class="card car-card h-100">
                            {% if car.images %}
                                <img src="{{ (car.images[0] if not car.images[0].lower().startswith('http') else car.images[0]) | safe if car.images else '' }}" class="card-img-top" alt="{{ car.name }}">
                            {% elif car.image_url %}
                                <img src="{{ car.image_url }}" class="card-img-top" alt="{{ car.name }}">
                            {% else %}
                                <img src="https://images.unsplash.com/photo-1525562723836-dca67a71d5f2?auto=format&fit=crop&w=900&q=80" class="card-img-top" alt="{{ car.name }}">
                            {% endif %}
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h3 class="h5 mb-1">{{ car.name }}</h3>
                                        <div class="text-muted small"><i class="bi bi-geo-alt"></i> {{ car.city or detected_city or 'Nearby' }} - {{ car.distance_km }} km away</div>
                                    </div>
                                    <span class="badge {{ 'bg-success' if car.status == 'Available' else 'bg-secondary' }}">{{ car.status }}</span>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mb-3 small text-muted">
                                    <span><i class="bi bi-fuel-pump"></i> {{ car.fuel_type or 'Fuel' }}</span>
                                    <span><i class="bi bi-gear-wide-connected"></i> {{ car.transmission or 'Transmission' }}</span>
                                    <span><i class="bi bi-people-fill"></i> {{ car.seats }} seats</span>
                                    {% if car.vehicle_type %}<span><i class="bi bi-car-front"></i> {{ car.vehicle_type }}</span>{% endif %}
                                    {% if car.has_gps %}<span><i class="bi bi-broadcast"></i> GPS ready</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ car.description or 'Flexible cancellation - Sanitised & ready - Unlimited km packages available' }}</p>
                                {% if pricing_info %}
                                    <div class="p-3 bg-light rounded-4 mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-semibold">&#8377; {{ pricing_info.total|round|int }} estimated</div>
                                                <div class="text-muted small">{{ pricing_info.hours }} hrs - Base &#8377; {{ pricing_info.base_amount|round }}{% if pricing_info.discount %} - Discount &#8377; {{ pricing_info.discount|round }}{% endif %}</div>
                                            </div>
                                            <div class="text-muted small">From &#8377; {{ (car.rate_per_hour * 4)|round|int }} / day approx</div>
                                        </div>
                                        <div class="mt-2 text-muted small">Suggested packs:
                                            {% for pack in pricing_info.packages %}
                                                <span class="badge bg-success-subtle text-success fw-semibold">{{ pack.label }} - &#8377; {{ pack.price|round|int }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="mt-auto">
                                    {% if car.status == 'Available' %}
                                        <form method="post" action="{{ url_for('rent_car', car_id=car.id) }}" class="row g-2">
                                            <input type="hidden" name="start_time" value="{{ start_time or '' }}">
                                            <input type="hidden" name="end_time" value="{{ end_time or '' }}">
                                            <input type="hidden" name="price_unit" value="{{ filters.price_unit }}">
                                            <div class="col-12">
                                                <label class="form-label small text-muted" for="promo-{{ car.id }}">Promo code (optional)</label>
                                                <input type="text" class="form-control" id="promo-{{ car.id }}" name="promo_code" placeholder="e.g. ZOOM10">
                                            </div>
                                            <div class="col-12 d-grid">
                                                <button type="submit" class="btn btn-success">Reserve instantly</button>
                                            </div>
                                        </form>
                                    {% else %}
                                        <button class="btn btn-outline-secondary w-100" disabled>Currently unavailable</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif latitude is not none and longitude is not none and not error %}
            <div class="alert alert-info" role="alert">
                No vehicles matched the current search. Try increasing the radius or choosing a different location.
            </div>
        {% else %}
            <div class="alert alert-secondary" role="alert">
                Select a pickup spot on the map to see vehicles nearby.
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        const cityInput = document.getElementById('city-field');
        const suggestionPanel = document.getElementById('city-suggestions');
        const cityOptions = {{ city_entries|tojson|safe }};
        let clearLocation = () => {};
        if (cityInput && suggestionPanel) {
            const normalised = [];
            const seen = new Set();
            const buildLabel = (item) => item.state ? `${item.name}, ${item.state}` : item.name;
            cityOptions.forEach((entry) => {
                if (!entry || !entry.name) {
                    return;
                }
                const label = buildLabel(entry);
                if (seen.has(label.toLowerCase())) {
                    return;
                }
                seen.add(label.toLowerCase());
                normalised.push({ value: label, label });
            });
            normalised.sort((a, b) => a.label.localeCompare(b.label));
            let activeIndex = -1;
            let currentResults = [];

            const hideSuggestions = () => {
                suggestionPanel.classList.add('d-none');
                suggestionPanel.innerHTML = '';
                cityInput.setAttribute('aria-expanded', 'false');
                activeIndex = -1;
                currentResults = [];
            };

            const highlight = (index) => {
                const items = suggestionPanel.querySelectorAll('[data-value]');
                items.forEach((item, idx) => {
                    item.classList.toggle('active', idx === index);
                });
                activeIndex = index;
            };

            const applySelection = (value) => {
                cityInput.value = value;
                hideSuggestions();
                clearLocation();
                cityInput.dispatchEvent(new Event('change'));
            };

            const renderSuggestions = (term) => {
                const query = term.trim().toLowerCase();
                const results = query
                    ? normalised.filter((option) => option.label.toLowerCase().includes(query)).slice(0, 12)
                    : normalised.slice(0, 12);
                suggestionPanel.innerHTML = '';
                if (!results.length) {
                    suggestionPanel.innerHTML = '<div class="list-group-item text-muted small">No matching cities found</div>';
                    suggestionPanel.classList.remove('d-none');
                    cityInput.setAttribute('aria-expanded', 'true');
                    currentResults = [];
                    activeIndex = -1;
                    return;
                }
                const fragment = document.createDocumentFragment();
                results.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'list-group-item list-group-item-action text-start';
                    button.setAttribute('data-value', option.value);
                    button.setAttribute('role', 'option');
                    button.dataset.index = String(index);
                    button.textContent = option.label;
                    fragment.appendChild(button);
                });
                suggestionPanel.appendChild(fragment);
                suggestionPanel.classList.remove('d-none');
                cityInput.setAttribute('aria-expanded', 'true');
                currentResults = results;
                activeIndex = -1;
            };

            cityInput.addEventListener('focus', () => {
                renderSuggestions(cityInput.value);
            });
            cityInput.addEventListener('input', () => {
                clearLocation();
                renderSuggestions(cityInput.value);
            });
            cityInput.addEventListener('keydown', (event) => {
                if (suggestionPanel.classList.contains('d-none')) {
                    return;
                }
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (!currentResults.length) {
                        return;
                    }
                    const nextIndex = activeIndex + 1 >= currentResults.length ? 0 : activeIndex + 1;
                    highlight(nextIndex);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    if (!currentResults.length) {
                        return;
                    }
                    const prevIndex = activeIndex - 1 < 0 ? currentResults.length - 1 : activeIndex - 1;
                    highlight(prevIndex);
                } else if (event.key === 'Enter') {
                    if (activeIndex >= 0 && currentResults[activeIndex]) {
                        event.preventDefault();
                        applySelection(currentResults[activeIndex].value);
                    }
                } else if (event.key === 'Escape') {
                    hideSuggestions();
                }
            });
            cityInput.addEventListener('blur', () => {
                window.setTimeout(hideSuggestions, 120);
            });
            suggestionPanel.addEventListener('pointerdown', (event) => {
                const target = event.target.closest('[data-value]');
                if (!target) {
                    return;
                }
                event.preventDefault();
                applySelection(target.getAttribute('data-value') || '');
            });
        }
    </script>
    <script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
    <script>
        const mapElement = document.getElementById('map');
        const latitudeField = document.getElementById('latitude-field');
        const longitudeField = document.getElementById('longitude-field');
        const radiusInput = document.getElementById('radius');
        const useLocationBtn = document.getElementById('use-location');
        const selectedText = document.getElementById('selected-location');
        const searchForm = document.getElementById('search-form');
        const startField = document.getElementById('start-field');
        const endField = document.getElementById('end-field');
        const initialLat = {{ latitude if latitude is not none else 'null' }};
        const initialLng = {{ longitude if longitude is not none else 'null' }};
        const initialRadius = {{ radius or 10 }};
        const carsData = {{ cars_payload|tojson|safe }};
        const pad = (value) => value.toString().padStart(2, '0');
        const formatDateTime = (date) => `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;

        if (cityInput) {
            clearLocation = () => {
                latitudeField.value = '';
                longitudeField.value = '';
            };
            cityInput.addEventListener('change', clearLocation);
        }

        const DEFAULT_VIEW = { lat: 20.5937, lng: 78.9629, zoom: 5 };
        const map = L.map(mapElement, { zoomControl: true });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        let locationMarker = null;
        let radiusCircle = null;
        const carLayer = L.layerGroup().addTo(map);

        const ensureMapSize = () => {
            map.invalidateSize();
        };

        map.whenReady(() => {
            ensureMapSize();
            setTimeout(ensureMapSize, 150);
        });

        if ('ResizeObserver' in window) {
            const resizeObserver = new ResizeObserver(() => ensureMapSize());
            resizeObserver.observe(mapElement);
        } else {
            window.addEventListener('resize', ensureMapSize);
        }

        window.addEventListener('load', () => setTimeout(ensureMapSize, 200));
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(ensureMapSize, 100);
            }
        });

        function focusOn(lat, lng, zoom = 13) {
            map.setView([lat, lng], zoom);
            ensureMapSize();
        }

        function updateSelectedLocation(lat, lng) {
            latitudeField.value = lat;
            longitudeField.value = lng;
            selectedText.innerHTML = `
                <span class="fw-semibold text-success">Pickup pinned</span>
                <span class="text-muted small d-block">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>`;
            if (!locationMarker) {
                locationMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
                locationMarker.on('dragend', (event) => {
                    const pos = event.target.getLatLng();
                    updateSelectedLocation(pos.lat, pos.lng);
                    redrawRadius();
                });
            } else {
                locationMarker.setLatLng([lat, lng]);
            }
            redrawRadius();
            ensureMapSize();
        }

        function radiusToZoom(km) {
            if (!Number.isFinite(km) || km <= 0) {
                return 13;
            }
            if (km <= 3) return 14;
            if (km <= 8) return 13;
            if (km <= 15) return 12;
            if (km <= 30) return 11;
            if (km <= 60) return 10;
            if (km <= 120) return 9;
            if (km <= 240) return 8;
            if (km <= 480) return 7;
            if (km <= 960) return 6;
            return 5;
        }

        function fitToRadius(padding = 0.2) {
            if (radiusCircle) {
                const bounds = radiusCircle.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(padding));
                    return;
                }
            }
            if (locationMarker) {
                map.setView(locationMarker.getLatLng(), radiusToZoom(parseFloat(radiusInput.value) || initialRadius));
            }
        }

        function redrawRadius({ adjustView = false } = {}) {
            const lat = parseFloat(latitudeField.value);
            const lng = parseFloat(longitudeField.value);
            const rawKm = parseFloat(radiusInput.value);
            const km = Number.isFinite(rawKm) && rawKm > 0 ? rawKm : initialRadius;
            if (!Number.isFinite(rawKm) || rawKm <= 0) {
                radiusInput.value = km.toString();
            }
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                if (radiusCircle) {
                    radiusCircle.remove();
                    radiusCircle = null;
                }
                return;
            }
            const radiusMeters = km * 1000;
            if (!radiusCircle) {
                radiusCircle = L.circle([lat, lng], {
                    radius: radiusMeters,
                    color: '#0d9f5c',
                    weight: 2,
                    fillColor: '#34d399',
                    fillOpacity: 0.15,
                }).addTo(map);
            } else {
                radiusCircle.setLatLng([lat, lng]);
                radiusCircle.setRadius(radiusMeters);
            }
            if (adjustView) {
                map.setView([lat, lng], radiusToZoom(km));
            }
        }

        map.on('click', (event) => {
            updateSelectedLocation(event.latlng.lat, event.latlng.lng);
            redrawRadius({ adjustView: true });
            fitToRadius();
        });

        const handleRadiusInput = () => redrawRadius({ adjustView: true });
        radiusInput.addEventListener('change', handleRadiusInput);
        radiusInput.addEventListener('input', handleRadiusInput);

        if (Number.isFinite(initialLat) && Number.isFinite(initialLng)) {
            updateSelectedLocation(initialLat, initialLng);
            redrawRadius({ adjustView: true });
            if (!carsData || !carsData.length) {
                fitToRadius();
            }
        } else {
            focusOn(DEFAULT_VIEW.lat, DEFAULT_VIEW.lng, DEFAULT_VIEW.zoom);
        }

        if (carsData && carsData.length) {
            carsData.forEach((car) => {
                const marker = L.marker([car.latitude, car.longitude]);
                marker.bindPopup(`
                    <strong>${car.name}</strong><br>
                    ${car.distance_km} km away - ${car.seats} seats<br>
                    &#8377; ${(car.rate_per_hour * 4).toFixed(0)} / day approx
                `);
                marker.addTo(carLayer);
            });
            const bounds = L.latLngBounds(carsData.map(car => [car.latitude, car.longitude]));
            if (locationMarker) {
                bounds.extend(locationMarker.getLatLng());
            }
            if (radiusCircle) {
                bounds.extend(radiusCircle.getBounds());
            }
            map.fitBounds(bounds.pad(0.2));
            ensureMapSize();
        }

        if (useLocationBtn && navigator.geolocation) {
            useLocationBtn.addEventListener('click', () => {
                useLocationBtn.disabled = true;
                useLocationBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Locating...';
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    focusOn(latitude, longitude);
                    updateSelectedLocation(latitude, longitude);
                    useLocationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Location set';
                    useLocationBtn.classList.remove('btn-outline-success');
                    useLocationBtn.classList.add('btn-success');
                    useLocationBtn.disabled = false;
                }, () => {
                    alert('Unable to fetch location. Please allow access or click on the map.');
                    useLocationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Use my current location';
                    useLocationBtn.disabled = false;
                });
            });
        } else if (useLocationBtn) {
            useLocationBtn.style.display = 'none';
        }

        const syncEndConstraints = () => {
            if (!startField || !endField || !startField.value) {
                return;
            }
            endField.min = startField.value;
            if (!endField.value || endField.value <= startField.value) {
                const startDate = new Date(startField.value);
                const adjusted = new Date(startDate.getTime() + 60 * 60 * 1000);
                endField.value = formatDateTime(adjusted);
            }
        };

        if (startField) {
            startField.addEventListener('change', () => {
                syncEndConstraints();
            });
        }
        if (endField) {
            endField.addEventListener('change', () => {
                syncEndConstraints();
            });
        }

        searchForm.addEventListener('submit', (event) => {
            if (startField && endField && startField.value && endField.value && endField.value <= startField.value) {
                event.preventDefault();
                alert('Trip end time must be after the start time.');
                endField.focus();
                return;
            }
            const hasCoordinates = Boolean(latitudeField.value && longitudeField.value);
            const cityValue = cityInput ? cityInput.value.trim() : '';
            if (!hasCoordinates && !cityValue) {
                event.preventDefault();
                alert('Please select a pickup location on the map or enter a city before searching.');
            }
        });

        if (startField && !startField.value) {
            const now = new Date();
            now.setMinutes(0, 0, 0);
            const start = new Date(now.getTime() + 60 * 60 * 1000);
            const end = new Date(start.getTime() + 4 * 60 * 60 * 1000);
            startField.value = formatDateTime(start);
            if (endField && !endField.value) {
                endField.value = formatDateTime(end);
            }
        }
        syncEndConstraints();
    </script>
{% endblock %}


